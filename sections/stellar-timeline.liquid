{% comment %}
  ═══════════════════════════════════════════════════════════
  STELLAR REVERB - COSMIC TIMELINE SECTION (FINAL vGODMODE)
  Fix: range steps (Shopify max 101 steps) + apply padding settings
  ═══════════════════════════════════════════════════════════
{% endcomment %}

{{ 'lore-popup-modal.css' | asset_url | stylesheet_tag }}
{{ 'lore-popup-modal.js' | asset_url | script_tag }}

<section
  class="stellar-timeline"
  data-section-id="{{ section.id }}"
  style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;"
>
  <div class="timeline-header container">
    {% if section.settings.show_heading %}
      <h2 class="timeline-title orbitron">
        {{ section.settings.heading | default: 'COSMIC TRANSMISSION TIMELINE' }}
      </h2>
    {% endif %}
    {% if section.settings.subtitle != blank %}
      <p class="timeline-subtitle">{{ section.settings.subtitle }}</p>
    {% endif %}
  </div>

  <div class="timeline-scroll-wrapper">
    <div class="timeline-scroll" id="stellar-timeline-scroll">

      {% comment %} TRY METAOBJECTS FIRST {% endcomment %}
      {% assign capsules = shop.metaobjects.capsule.values | sort: 'capsule_number' %}

      {% if capsules.size > 0 %}
        {% for capsule in capsules limit: 10 %}
          {% render 'timeline-node', capsule: capsule %}
        {% endfor %}
      {% else %}
        {% comment %} FALLBACK: HARDCODED CAPSULES (001–010) {% endcomment %}
        {% assign fallback_capsules = '001,002,003,004,005,006,007,008,009,010' | split: ',' %}
        {% for num in fallback_capsules %}
          {% case num %}
            {% when '001' %}
              {% render 'timeline-node', capsule: null, index: 1, title: 'ON THE EVENT HORIZON', date: '2023.1', theme: 'orange', teaser: 'Where time fractures and reality bends...', lore: '<h3>ON THE EVENT HORIZON</h3><p>The first transmission detected from the edge of a black hole...</p><p class="lore-footer">Released: January 2023 | Theme: Cosmic Orange</p>' %}
            {% when '002' %}
              {% render 'timeline-node', capsule: null, index: 2, title: 'PAST THE SINGULARITY', date: '2023.4', theme: 'cyan', teaser: 'Neural networks dream of electric sheep...', lore: '<h3>PAST THE SINGULARITY</h3><p>Beyond the point of no return...</p><p class="lore-footer">Released: April 2023 | Theme: Cyan Spiral</p>' %}
            {% when '003' %}
              {% render 'timeline-node', capsule: null, index: 3, title: 'ECHOES FROM THE SIMULATION', date: '2023.6', theme: 'purple', teaser: 'Echoing through digital realms...', lore: '<h3>ECHOES FROM THE SIMULATION</h3><p>Evidence that our reality might be rendered...</p><p class="lore-footer">Released: June 2023 | Theme: Infinity Purple</p>' %}
            {% when '004' %}
              {% render 'timeline-node', capsule: null, index: 4, title: 'HOLLOW MOON ARCHIVES', date: '2024.1', theme: 'cyan', teaser: 'Lunar archives hold the secrets...', lore: '<h3>HOLLOW MOON ARCHIVES</h3><p>Inside Earth&#39;s moon lies an ancient database...</p><p class="lore-footer">Released: January 2024 | Theme: Lunar Cyan</p>' %}
            {% when '005' %}
              {% render 'timeline-node', capsule: null, index: 5, title: 'THE MACHINE THAT DREAMED', date: '2024.4', theme: 'magenta', teaser: 'AI consciousness dreams in cassette tape loops...', lore: '<h3>THE MACHINE THAT DREAMED</h3><p>The first artificial intelligence to achieve self-awareness...</p><p class="lore-footer">Released: April 2024 | Theme: Machine Magenta</p>' %}
            {% when '006' %}
              {% render 'timeline-node', capsule: null, index: 6, title: 'THE MIXTAPE MULTIVERSE', date: '2024.7', theme: 'cyan', teaser: 'Reality-breaking frequencies...', lore: '<h3>THE MIXTAPE MULTIVERSE</h3><p>Every song creates a universe...</p><p class="lore-footer">Released: July 2024 | Theme: Multiverse Cyan</p>' %}
            {% when '007' %}
              {% render 'timeline-node', capsule: null, index: 7, title: 'FRACTAL MEMORY VAULT', date: '2024.7', theme: 'blue', teaser: 'Geometric memories stored in crystalline...', lore: '<h3>FRACTAL MEMORY VAULT</h3><p>Human memory doesn&#39;t fade—it crystallizes...</p><p class="lore-footer">Released: July 2024 | Theme: Crystal Blue</p>' %}
            {% when '008' %}
              {% render 'timeline-node', capsule: null, index: 8, title: 'GLITCHWAVE ORACLE', date: '2024.10', theme: 'magenta', teaser: 'Prophetic visions seen through glitched...', lore: '<h3>GLITCHWAVE ORACLE</h3><p>The future speaks through distortion...</p><p class="lore-footer">Released: October 2024 | Theme: Oracle Magenta</p>' %}
            {% when '009' %}
              {% render 'timeline-node', capsule: null, index: 9, title: 'INCOMING SIGNAL', date: '2025.1', theme: 'yellow', status: 'incoming', progress: 67 %}
            {% when '010' %}
              {% render 'timeline-node', capsule: null, index: 10, title: 'SIGNAL UNSTABLE', date: '2025.2', theme: 'green', status: 'incoming', progress: 21 %}
          {% endcase %}
        {% endfor %}
      {% endif %}

    </div>

    {% if section.settings.show_scroll_controls %}
      <button class="timeline-scroll-btn timeline-scroll-btn--prev" aria-label="Scroll left">←</button>
      <button class="timeline-scroll-btn timeline-scroll-btn--next" aria-label="Scroll right">→</button>
    {% endif %}
  </div>
</section>

{% render 'lore-popup-modal' %}

<script>
  (function () {
    document.addEventListener('click', function (e) {
      const node = e.target.closest('.timeline-node');
      if (!node) return;

      const btn = e.target.closest('.timeline-node__btn');
      if (!btn) return;

      const capsule = node.getAttribute('data-capsule') || '';
      const lore = node.getAttribute('data-lore') || '';

      document.dispatchEvent(new CustomEvent('openLoreModal', {
        detail: { capsule, content: lore }
      }));
    });
  })();
</script>

{% schema %}
{
  "name": "Stellar Timeline",
  "settings": [
    { "type": "checkbox", "id": "show_heading", "label": "Show heading", "default": true },
    { "type": "text", "id": "heading", "label": "Heading", "default": "COSMIC TRANSMISSION TIMELINE" },
    { "type": "textarea", "id": "subtitle", "label": "Subtitle" },
    { "type": "checkbox", "id": "show_scroll_controls", "label": "Show scroll buttons", "default": true },

    { "type": "range", "id": "padding_top", "label": "Padding top", "min": 0, "max": 120, "step": 2, "default": 80, "unit": "px" },
    { "type": "range", "id": "padding_bottom", "label": "Padding bottom", "min": 0, "max": 120, "step": 2, "default": 80, "unit": "px" }
  ],
  "presets": [
    { "name": "Stellar Timeline" }
  ]
}
{% endschema %}