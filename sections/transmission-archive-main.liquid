{% comment %}
  STELLAR REVERB â€“ Transmission Archive Main Section
  Refactored from standalone HTML into Shopify OS 2.0 section
{% endcomment %}

{% assign transmission_collection = collections['transmissions'] %}
{% assign featured_transmission = transmission_collection.products.first %}
{% assign nav_menu_handle = section.settings.menu | default: 'main-menu' %}
{% assign nav_menu = linklists[nav_menu_handle] %}

{% render 'transmission-archive-styles' %}

<section class="transmission-archive-page" data-section-id="{{ section.id }}">
  <!-- Cosmic Background System -->
  <div class="cosmic-bg"></div>
  <div class="cosmic-overlay"></div>
  
  <!-- Floating Cassettes Animation (Lazy Loaded) -->
  <div class="floating-cassettes lazy" id="floatingCassettes">
    {% for i in (1..9) %}
      <div class="floating-cassette" style="--delay: {{ i | times: 3 }}s"></div>
    {% endfor %}
  </div>
  
  <!-- Navigation (page-local cosmic nav) -->
  <nav class="nav-bar" role="navigation" aria-label="Main Navigation">
    <div class="nav-content">
      <div class="brand-logo">
        <div class="brand-cassette" aria-hidden="true"></div>
        <div class="brand-text">STELLAR REVERB</div>
      </div>
      <div class="nav-links">
        {% if nav_menu.links.size > 0 %}
          {% for link in nav_menu.links %}
            <a href="{{ link.url }}" class="nav-link">{{ link.title | upcase }}</a>
          {% endfor %}
        {% endif %}
        <a href="#signal-signup" class="nav-link signal-seekers" id="signalSeeker">SIGNAL SEEKER</a>
      </div>
    </div>
  </nav>
  
  <!-- Hero Section -->
  <section class="hero-section" id="heroSection">
    <div class="hero-content">
      <div class="visualizer-panel">
        <img
          src="{{ 'hero-visualizer.jpg' | asset_url }}"
          alt="Transmission Visualizer"
          class="visualizer-image"
          loading="eager">
      </div>
      <div class="hero-text">
        <h1 class="hero-title">
          {{ page.title | default: 'COSMIC CODEX' | upcase }}
        </h1>
        <p class="hero-subtitle">
          {{ page.content | strip_html | truncatewords: 12 | default: 'Archive of Interdimensional Transmissions' }}
        </p>
        <div class="hero-controls">
          <button class="dimensional-btn primary" id="enterArchive" type="button">
            ENTER ARCHIVE
          </button>
          <button class="dimensional-btn secondary" id="mythToggle" type="button">
            TOGGLE LORE
          </button>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Archive Timeline Section -->
  <section class="timeline-section" id="timelineSection">
    <div class="section-header">
      <h2 class="section-title">TRANSMISSION TIMELINE</h2>
      <p class="section-subtitle">Navigate through dimensions of cosmic consciousness</p>
    </div>
    
    <!-- Filters -->
    <div class="timeline-filters">
      <div class="filter-group">
        <label for="eraFilter" class="filter-label">ERA:</label>
        <select id="eraFilter" class="cosmic-select">
          <option value="all">ALL ERAS</option>
          <option value="ancient">ANCIENT</option>
          <option value="modern">MODERN</option>
          <option value="future">FUTURE</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="typeFilter" class="filter-label">TYPE:</label>
        <select id="typeFilter" class="cosmic-select">
          <option value="all">ALL TYPES</option>
          <option value="cassette">CASSETTE</option>
          <option value="vinyl">VINYL</option>
          <option value="digital">DIGITAL</option>
        </select>
      </div>
    </div>
    
    <!-- Timeline Nodes -->
    <div class="timeline-container">
      {% for product in transmission_collection.products limit: 12 %}
        <article class="timeline-node"
          data-era="{{ product.metafields.transmission_data.era | default: 'modern' }}"
          data-type="{{ product.metafields.transmission_data.type | default: 'cassette' }}"
          data-product-id="{{ product.id }}">
          
          <div class="node-connector"></div>
          
          <div class="node-content">
            <div class="node-image-wrapper">
              {% if product.featured_image %}
                <img
                  src="{{ product.featured_image | image_url: width: 300 }}"
                  alt="{{ product.title }}"
                  class="node-image lazy"
                  loading="lazy">
              {% else %}
                <div class="node-placeholder">
                  <span class="cassette-icon">ðŸŽµ</span>
                </div>
              {% endif %}
              <div class="node-overlay">
                <button
                  class="play-btn"
                  type="button"
                  data-audio="{{ product.metafields.transmission_data.audio_url }}"
                  aria-label="Play {{ product.title }}">
                  â–¶
                </button>
              </div>
            </div>
            
            <div class="node-details">
              <h3 class="node-title">
                <a href="{{ product.url }}">{{ product.title }}</a>
              </h3>
              <p class="node-teaser">
                {{ product.metafields.transmission_data.teaser | default: product.description | strip_html | truncatewords: 15 }}
              </p>
              <div class="node-metadata">
                <span class="node-price">{{ product.price | money }}</span>
                {% if product.metafields.transmission_data.spotify_url %}
                  <a
                    href="{{ product.metafields.transmission_data.spotify_url }}"
                    class="spotify-link"
                    target="_blank"
                    rel="noopener"
                    aria-label="Listen on Spotify">
                    ðŸŽ§
                  </a>
                {% endif %}
              </div>
              
              {% if product.metafields.transmission_data.lore %}
                <div class="node-lore hidden" id="lore-{{ product.id }}">
                  <div class="lore-content">
                    {{ product.metafields.transmission_data.lore | newline_to_br }}
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          
          {% if product.metafields.transmission_data.model_url %}
            <div class="ar-portal" data-model="{{ product.metafields.transmission_data.model_url }}">
              <button class="ar-btn" type="button">AR VIEW</button>
            </div>
          {% endif %}
        </article>
      {% endfor %}
    </div>
    
    <div class="timeline-actions">
      <button class="dimensional-btn primary" id="loadMore" type="button">
        LOAD MORE TRANSMISSIONS
      </button>
    </div>
  </section>
  
  <!-- Vault Section -->
  <section class="vault-section" id="vaultSection">
    <div class="section-header">
      <h2 class="section-title">STELLAR VAULT</h2>
      <p class="section-subtitle">Curated collections of cosmic consciousness</p>
    </div>
    
    <div class="vault-grid">
      {% for collection in collections %}
        {% if collection.handle contains 'transmission' %}
          <div class="vault-capsule">
            <div class="capsule-inner">
              <div class="capsule-image">
                {% if collection.image %}
                  <img
                    src="{{ collection.image | image_url: width: 400 }}"
                    alt="{{ collection.title }}"
                    loading="lazy">
                {% else %}
                  <div class="capsule-placeholder">
                    <span class="cosmic-icon">ðŸŒŒ</span>
                  </div>
                {% endif %}
              </div>
              <div class="capsule-content">
                <h3 class="capsule-title">{{ collection.title }}</h3>
                <p class="capsule-description">
                  {{ collection.description | strip_html | truncatewords: 20 }}
                </p>
                <div class="capsule-stats">
                  <span class="product-count">{{ collection.products.size }} Transmissions</span>
                </div>
                <a href="{{ collection.url }}" class="dimensional-btn secondary">
                  EXPLORE VAULT
                </a>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </section>
  
  <!-- Signals Section -->
  <section class="signals-section" id="signalsSection">
    <div class="section-header">
      <h2 class="section-title">LIVE SIGNALS</h2>
      <p class="section-subtitle">Real-time transmissions from the cosmos</p>
    </div>
    
    <div class="signals-feed" id="signalsFeed">
      <!-- Populated via JavaScript -->
    </div>
  </section>
  
  <!-- Rift Signup -->
  <section class="rift-signup" id="signal-signup">
    <div class="rift-container">
      <div class="rift-content">
        <h2 class="rift-title">ENTER THE RIFT</h2>
        <p class="rift-subtitle">
          Subscribe to receive exclusive transmissions and early access to dimensional archives
        </p>
        
        <form class="rift-form" id="klaviyoForm" action="#" method="post">
          <div class="form-group">
            <input
              type="email"
              name="email"
              placeholder="Enter your cosmic frequency..."
              class="rift-input"
              required>
          </div>
          <div class="form-group">
            <input
              type="text"
              name="cosmic_name"
              placeholder="Your interdimensional alias..."
              class="rift-input">
          </div>
          <button type="submit" class="dimensional-btn primary rift-submit">
            INITIALIZE RIFT CONNECTION
          </button>
        </form>
      </div>
    </div>
  </section>
  
  <!-- Secret Konami Archive -->
  <div class="secret-archive hidden" id="secretArchive">
    <div class="secret-content">
      <h2>ðŸ”’ CLASSIFIED TRANSMISSIONS UNLOCKED ðŸ”’</h2>
      <p>You've discovered the hidden archive. Access granted to dimensional frequency 777.7FM</p>
      <div class="secret-transmissions">
        {% assign secret_collection = collections['secret-transmissions'] %}
        {% if secret_collection and secret_collection.products.size > 0 %}
          {% for product in secret_collection.products limit: 3 %}
            <div class="secret-item">
              <img
                src="{{ product.featured_image | image_url: width: 150 }}"
                alt="{{ product.title }}">
              <h4>{{ product.title }}</h4>
              <a href="{{ product.url }}" class="dimensional-btn mini">ACCESS</a>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Audio Player -->
  <div class="cosmic-player hidden" id="cosmicPlayer">
    <div class="player-content">
      <div class="player-info">
        <span class="track-title">Loading transmission...</span>
      </div>
      <div class="player-controls">
        <button class="play-pause-btn" type="button" id="playPauseBtn">â–¶</button>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <button class="close-player" type="button" id="closePlayer">âœ•</button>
      </div>
      <audio id="audioElement" preload="none"></audio>
    </div>
  </div>
  
  <!-- Non-critical styles -->
  <link rel="stylesheet" href="{{ 'transmission-archive.css' | asset_url }}" media="print" onload="this.media='all'">
  
  <!-- Scripts (inline JS from original file) -->
  <script type="module">
    const konamiCode = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','KeyB','KeyA'];
    let konamiInput = [];
    
    document.addEventListener('keydown', (e) => {
      konamiInput.push(e.code);
      if (konamiInput.length > konamiCode.length) {
        konamiInput.shift();
      }
      if (JSON.stringify(konamiInput) === JSON.stringify(konamiCode)) {
        document.getElementById('secretArchive').classList.remove('hidden');
        console.log('ðŸŽµ Secret Archive Unlocked! Welcome to Frequency 777.7FM ðŸŽµ');
      }
    });
    
    const observerOptions = { rootMargin: '50px 0px', threshold: 0.01 };
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const element = entry.target;
          element.classList.remove('lazy');
          observer.unobserve(element);
        }
      });
    }, observerOptions);
    document.querySelectorAll('.lazy').forEach(el => observer.observe(el));
    
    class CosmicPlayer {
      constructor() {
        this.player = document.getElementById('cosmicPlayer');
        this.audio = document.getElementById('audioElement');
        this.playPauseBtn = document.getElementById('playPauseBtn');
        this.progressBar = document.getElementById('progressBar');
        this.trackTitle = document.querySelector('.track-title');
        this.setupEventListeners();
      }
      setupEventListeners() {
        document.querySelectorAll('.play-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const audioUrl = e.target.dataset.audio;
            const title = e.target.closest('.timeline-node').querySelector('.node-title a').textContent;
            if (audioUrl) this.loadAndPlay(audioUrl, title);
          });
        });
        this.playPauseBtn?.addEventListener('click', () => this.togglePlayPause());
        document.getElementById('closePlayer')?.addEventListener('click', () => this.close());
        this.audio.addEventListener('timeupdate', () => this.updateProgress());
        this.audio.addEventListener('ended', () => this.onTrackEnded());
      }
      loadAndPlay(url, title) {
        this.audio.src = url;
        this.trackTitle.textContent = title;
        this.player.classList.remove('hidden');
        this.audio.play();
        this.playPauseBtn.textContent = 'â¸';
      }
      togglePlayPause() {
        if (this.audio.paused) {
          this.audio.play();
          this.playPauseBtn.textContent = 'â¸';
        } else {
          this.audio.pause();
          this.playPauseBtn.textContent = 'â–¶';
        }
      }
      updateProgress() {
        if (!this.audio.duration) return;
        const progress = (this.audio.currentTime / this.audio.duration) * 100;
        this.progressBar.style.width = `${progress}%`;
      }
      onTrackEnded() {
        this.playPauseBtn.textContent = 'â–¶';
        this.progressBar.style.width = '0%';
      }
      close() {
        this.audio.pause();
        this.audio.src = '';
        this.player.classList.add('hidden');
      }
    }
    
    class TimelineFilters {
      constructor() {
        this.eraFilter = document.getElementById('eraFilter');
        this.typeFilter = document.getElementById('typeFilter');
        this.nodes = document.querySelectorAll('.timeline-node');
        this.setupEventListeners();
      }
      setupEventListeners() {
        this.eraFilter?.addEventListener('change', () => this.applyFilters());
        this.typeFilter?.addEventListener('change', () => this.applyFilters());
      }
      applyFilters() {
        const selectedEra = this.eraFilter.value;
        const selectedType = this.typeFilter.value;
        this.nodes.forEach(node => {
          const nodeEra = node.dataset.era;
          const nodeType = node.dataset.type;
          const eraMatch = selectedEra === 'all' || nodeEra === selectedEra;
          const typeMatch = selectedType === 'all' || nodeType === selectedType;
          if (eraMatch && typeMatch) {
            node.style.display = 'block';
            node.classList.add('filter-visible');
          } else {
            node.style.display = 'none';
            node.classList.remove('filter-visible');
          }
        });
        requestAnimationFrame(() => {
          document.querySelectorAll('.filter-visible').forEach((node, index) => {
            node.style.animationDelay = `${index * 0.1}s`;
            node.classList.add('fade-in');
          });
        });
      }
    }
    
    class LoreSystem {
      constructor() {
        this.mythToggle = document.getElementById('mythToggle');
        this.loreElements = document.querySelectorAll('.node-lore');
        this.isLoreVisible = false;
        this.setupEventListeners();
      }
      setupEventListeners() {
        this.mythToggle?.addEventListener('click', () => this.toggleLore());
      }
      toggleLore() {
        this.isLoreVisible = !this.isLoreVisible;
        this.loreElements.forEach((lore, index) => {
          setTimeout(() => {
            if (this.isLoreVisible) {
              lore.classList.remove('hidden');
              lore.classList.add('lore-reveal');
            } else {
              lore.classList.add('hidden');
              lore.classList.remove('lore-reveal');
            }
          }, index * 100);
        });
        this.mythToggle.textContent = this.isLoreVisible ? 'HIDE LORE' : 'TOGGLE LORE';
      }
    }
    
    class SignalsFeed {
      constructor() {
        this.feedContainer = document.getElementById('signalsFeed');
        this.loadSocialSignals();
        setInterval(() => this.loadSocialSignals(), 30000);
      }
      async loadSocialSignals() {
        try {
          const signals = await this.fetchSignals();
          this.renderSignals(signals);
        } catch (error) {
          console.log('Signals temporarily offline:', error);
          this.renderOfflineSignal();
        }
      }
      async fetchSignals() {
        return new Promise(resolve => {
          setTimeout(() => {
            resolve([
              {
                type: 'twitter',
                content: 'ðŸŽµ New transmission detected on frequency 432.7Hz... Cosmic resonance confirmed. #StellarReverb',
                timestamp: new Date(Date.now() - Math.random() * 3600000),
                author: '@CosmicListener'
              },
              {
                type: 'instagram',
                content: 'Just discovered an ancient cassette with interdimensional properties... ðŸŒŒ',
                timestamp: new Date(Date.now() - Math.random() * 7200000),
                author: '@DimensionalSeeker'
              }
            ]);
          }, Math.random() * 1000);
        });
      }
      renderSignals(signals) {
        if (!this.feedContainer) return;
        const signalCards = signals.map(signal => `
          <div class="signal-card glitch-card" data-type="${signal.type}">
            <div class="signal-header">
              <span class="signal-author">${signal.author}</span>
              <span class="signal-time">${this.formatTime(signal.timestamp)}</span>
            </div>
            <div class="signal-content">${signal.content}</div>
            <div class="signal-platform ${signal.type}"></div>
          </div>
        `).join('');
        this.feedContainer.innerHTML = signalCards;
      }
      renderOfflineSignal() {
        if (!this.feedContainer) return;
        this.feedContainer.innerHTML = `
          <div class="signal-card offline">
            <div class="signal-content">
              ðŸ“¡ Signals temporarily offline - Dimensional interference detected...
            </div>
          </div>
        `;
      }
      formatTime(timestamp) {
        const now = new Date();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        if (hours > 0) return `${hours}h ago`;
        if (minutes > 0) return `${minutes}m ago`;
        return 'just now';
      }
    }
    
    class RiftSignup {
      constructor() {
        this.form = document.getElementById('klaviyoForm');
        this.setupEventListeners();
      }
      setupEventListeners() {
        this.form?.addEventListener('submit', (e) => this.handleSubmit(e));
      }
      async handleSubmit(e) {
        e.preventDefault();
        const formData = new FormData(this.form);
        const email = formData.get('email');
        const cosmicName = formData.get('cosmic_name') || 'Unknown Traveler';
        try {
          await this.subscribeToRift(email, cosmicName);
          this.showSuccessMessage();
        } catch (error) {
          this.showErrorMessage();
        }
      }
      async subscribeToRift(email, name) {
        return new Promise((resolve) => {
          setTimeout(() => {
            console.log('Rift connection established for:', email, name);
            resolve();
          }, 1000);
        });
      }
      showSuccessMessage() {
        const submitBtn = this.form.querySelector('.rift-submit');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'ðŸŒŒ RIFT CONNECTION ESTABLISHED ðŸŒŒ';
        submitBtn.disabled = true;
        setTimeout(() => {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
          this.form.reset();
        }, 3000);
      }
      showErrorMessage() {
        const submitBtn = this.form.querySelector('.rift-submit');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'âš ï¸ DIMENSIONAL INTERFERENCE âš ï¸';
        setTimeout(() => {
          submitBtn.textContent = originalText;
        }, 3000);
      }
    }
    
    class ARPortalSystem {
      constructor() {
        this.setupARButtons();
      }
      setupARButtons() {
        document.querySelectorAll('.ar-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const portal = e.target.closest('.ar-portal');
            const modelUrl = portal.dataset.model;
            this.launchARViewer(modelUrl);
          });
        });
      }
      launchARViewer(modelUrl) {
        if ('xr' in navigator) {
          this.initWebXR(modelUrl);
        } else {
          this.openModelViewer(modelUrl);
        }
      }
      async initWebXR(modelUrl) {
        try {
          console.log('Launching AR portal for:', modelUrl);
        } catch (error) {
          this.openModelViewer(modelUrl);
        }
      }
      openModelViewer(modelUrl) {
        const viewer = document.createElement('model-viewer');
        viewer.src = modelUrl;
        viewer.setAttribute('ar', '');
        viewer.setAttribute('camera-controls', '');
        viewer.setAttribute('auto-rotate', '');
        viewer.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          z-index: 10000; background: rgba(0,0,0,0.9);
        `;
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
          position: absolute; top: 20px; right: 20px; z-index: 10001;
          background: var(--neon-magenta); color: white; border: none;
          padding: 10px 15px; border-radius: 50%; cursor: pointer;
        `;
        closeBtn.addEventListener('click', () => {
          document.body.removeChild(viewer);
        });
        viewer.appendChild(closeBtn);
        document.body.appendChild(viewer);
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      new CosmicPlayer();
      new TimelineFilters();
      new LoreSystem();
      new SignalsFeed();
      new RiftSignup();
      new ARPortalSystem();
      if ('PerformanceObserver' in window) {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.entryType === 'paint' && entry.name === 'first-contentful-paint') {
              console.log(`ðŸš€ FCP: ${entry.startTime}ms`);
              if (entry.startTime < 1000) {
                console.log('âœ… Performance target achieved: FCP < 1s');
              }
            }
          }
        });
        observer.observe({ entryTypes: ['paint'] });
      }
    });
  </script>
  
  <!-- Model Viewer for AR -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</section>

{% schema %}
{
  "name": "Transmission Archive Â· Main",
  "tag": "section",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "Navigation menu",
      "default": "main-menu"
    }
  ],
  "presets": [
    {
      "name": "Transmission Archive Â· Main"
    }
  ]
}
{% endschema %}