{% comment %}
  STELLAR REVERB - Lore Accordion (Fractured Narrative Expander)
  Expandable lore nodes with glitch-reveal, audio embed, sacred-triangle dividers
  Hover: scanlines + cyan waveform background
{% endcomment %}

<section 
  class="stellar-lore-accordion"
  data-section-id="{{ section.id }}"
  style="--lore-color: {{ section.settings.lore_color }};">

  <div class="lore-container">
    
    {%- if section.settings.heading != blank -%}
      <header class="lore-header">
        <div class="header-triangle" aria-hidden="true">
          <svg viewBox="0 0 100 100" preserveAspectRatio="none">
            <polygon points="50,10 90,90 10,90" fill="none" stroke="currentColor" stroke-width="2"/>
            <polygon points="50,25 75,75 25,75" fill="none" stroke="currentColor" stroke-width="1" opacity="0.5"/>
          </svg>
        </div>
        <h2 class="lore-title glitch-text" data-text="{{ section.settings.heading }}">
          {{ section.settings.heading }}
        </h2>
        {%- if section.settings.subtitle != blank -%}
          <p class="lore-subtitle">{{ section.settings.subtitle }}</p>
        {%- endif -%}
      </header>
    {%- endif -%}

    <div class="lore-nodes">
      {%- for block in section.blocks -%}
        {%- case block.type -%}
          {%- when 'lore_node' -%}
            <div class="lore-node" {{ block.shopify_attributes }} data-lore-node>
              
              <button class="node-trigger" data-node-trigger aria-expanded="false">
                <div class="trigger-content">
                  <span class="node-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                      <polygon points="12,2 22,22 2,22" stroke="currentColor" stroke-width="2"/>
                      <circle cx="12" cy="16" r="2" fill="currentColor"/>
                    </svg>
                  </span>
                  <span class="node-title">{{ block.settings.title }}</span>
                  {%- if block.settings.node_number != blank -%}
                    <span class="node-number">{{ block.settings.node_number }}</span>
                  {%- endif -%}
                </div>
                <span class="node-chevron">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 7.5l5 5 5-5"/>
                  </svg>
                </span>
              </button>

              <div class="node-content" data-node-content>
                <div class="content-inner">
                  
                  <div class="scanline-overlay" aria-hidden="true"></div>
                  <div class="waveform-bg" aria-hidden="true">
                    <svg viewBox="0 0 200 50" preserveAspectRatio="none">
                      <path class="wave" d="M0,25 Q50,10 100,25 T200,25" fill="none" stroke="currentColor" stroke-width="0.5"/>
                    </svg>
                  </div>

                  {%- if block.settings.content != blank -%}
                    <div class="node-text">
                      {{ block.settings.content }}
                    </div>
                  {%- endif -%}

                  {%- if block.settings.audio_url != blank -%}
                    <div class="node-audio">
                      <div class="audio-label">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M3 5v6l4-3-4-3zm8 0v6l4-3-4-3z"/>
                        </svg>
                        <span>AUDIO FRAGMENT</span>
                      </div>
                      <audio controls preload="none" class="audio-player">
                        <source src="{{ block.settings.audio_url }}" type="audio/mpeg">
                        Your browser does not support audio playback.
                      </audio>
                    </div>
                  {%- endif -%}

                  {%- if block.settings.image != blank -%}
                    <div class="node-image">
                      <img 
                        src="{{ block.settings.image | image_url: width: 800 }}" 
                        alt="{{ block.settings.title }}"
                        loading="lazy">
                    </div>
                  {%- endif -%}

                  {%- if block.settings.link_url != blank -%}
                    <a href="{{ block.settings.link_url }}" class="node-link">
                      {{ block.settings.link_text | default: "Explore Further" }}
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                        <path d="M1 8h14M9 2l6 6-6 6" stroke-width="2"/>
                      </svg>
                    </a>
                  {%- endif -%}

                </div>
              </div>

              <div class="node-divider" aria-hidden="true">
                <svg viewBox="0 0 100 20" preserveAspectRatio="none">
                  <polygon points="50,0 60,10 50,20 40,10" fill="currentColor" opacity="0.3"/>
                  <line x1="0" y1="10" x2="40" y2="10" stroke="currentColor" stroke-width="1" opacity="0.2"/>
                  <line x1="60" y1="10" x2="100" y2="10" stroke="currentColor" stroke-width="1" opacity="0.2"/>
                </svg>
              </div>

            </div>
        {%- endcase -%}
      {%- endfor -%}
    </div>

  </div>

</section>

<style>
.stellar-lore-accordion {
  padding: clamp(3rem, 8vw, 6rem) 1.5rem;
  background: linear-gradient(180deg, #000 0%, #0a0014 100%);
  position: relative;
}

.lore-container {
  max-width: 900px;
  margin: 0 auto;
}

.lore-header {
  text-align: center;
  margin-bottom: 3rem;
  position: relative;
}

.header-triangle {
  width: 60px;
  height: 60px;
  margin: 0 auto 1.5rem;
  color: var(--lore-color, #28A8D6);
  animation: triangleFloat 4s ease-in-out infinite;
}

@keyframes triangleFloat {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-10px) rotate(180deg); }
}

.lore-title {
  font-family: 'Orbitron', monospace;
  font-size: clamp(2rem, 5vw, 3rem);
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #FFF;
  margin: 0 0 1rem;
  position: relative;
  display: inline-block;
}

.glitch-text::before,
.glitch-text::after {
  content: attr(data-text);
  position: absolute;
  left: 0;
  top: 0;
}

.glitch-text::before {
  color: #FF006E;
  animation: glitch1 3s infinite;
  clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
}

.glitch-text::after {
  color: var(--lore-color, #28A8D6);
  animation: glitch2 3s infinite;
  clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
}

@keyframes glitch1 {
  0%, 100% { transform: translate(0); }
  33% { transform: translate(-2px, 2px); }
  66% { transform: translate(2px, -2px); }
}

@keyframes glitch2 {
  0%, 100% { transform: translate(0); }
  33% { transform: translate(2px, -2px); }
  66% { transform: translate(-2px, 2px); }
}

.lore-subtitle {
  color: #A0A0A0;
  font-size: 1rem;
  letter-spacing: 0.05em;
  max-width: 600px;
  margin: 0 auto;
}

.lore-nodes {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.lore-node {
  position: relative;
}

.node-trigger {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1.5rem 2rem;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 0;
  color: #FFF;
  font-family: 'Orbitron', monospace;
  font-size: 1rem;
  font-weight: 700;
  text-align: left;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.node-trigger::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--lore-color, #28A8D6);
  transform: scaleY(0);
  transition: transform 0.3s ease;
}

.node-trigger:hover::before {
  transform: scaleY(1);
}

.node-trigger:hover {
  background: rgba(40, 168, 214, 0.05);
  border-color: var(--lore-color, #28A8D6);
  padding-left: 2.5rem;
}

.node-trigger[aria-expanded="true"] {
  background: rgba(40, 168, 214, 0.08);
  border-bottom-color: transparent;
}

.node-trigger[aria-expanded="true"]::before {
  transform: scaleY(1);
}

.trigger-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1;
}

.node-icon {
  color: var(--lore-color, #28A8D6);
  display: flex;
  flex-shrink: 0;
}

.node-title {
  flex: 1;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.node-number {
  font-size: 0.75rem;
  color: #808080;
  padding: 0.25rem 0.75rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  font-weight: 600;
}

.node-chevron {
  color: var(--lore-color, #28A8D6);
  transition: transform 0.3s ease;
  display: flex;
  flex-shrink: 0;
}

.node-trigger[aria-expanded="true"] .node-chevron {
  transform: rotate(180deg);
}

.node-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.node-trigger[aria-expanded="true"] + .node-content {
  max-height: 2000px;
}

.content-inner {
  position: relative;
  padding: 2rem;
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-top: none;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.scanline-overlay {
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent 0px,
    rgba(40, 168, 214, 0.03) 1px,
    transparent 2px,
    transparent 4px
  );
  pointer-events: none;
  opacity: 0;
  animation: scanlinesFade 2s ease-in-out infinite;
}

@keyframes scanlinesFade {
  0%, 100% { opacity: 0; }
  50% { opacity: 1; }
}

.waveform-bg {
  position: absolute;
  inset: 0;
  color: var(--lore-color, #28A8D6);
  opacity: 0.05;
  pointer-events: none;
}

.waveform-bg .wave {
  animation: waveform 8s ease-in-out infinite;
}

@keyframes waveform {
  0%, 100% { d: path('M0,25 Q50,10 100,25 T200,25'); }
  50% { d: path('M0,25 Q50,40 100,25 T200,25'); }
}

.node-text {
  color: #D0D0D0;
  line-height: 1.8;
  position: relative;
  z-index: 1;
}

.node-text p {
  margin: 0 0 1rem;
}

.node-text p:last-child {
  margin-bottom: 0;
}

.node-audio {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  position: relative;
  z-index: 1;
}

.audio-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--lore-color, #28A8D6);
}

.audio-player {
  width: 100%;
  height: 40px;
  border-radius: 6px;
}

.audio-player::-webkit-media-controls-panel {
  background-color: rgba(255, 255, 255, 0.1);
}

.node-image {
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.1);
  position: relative;
  z-index: 1;
}

.node-image img {
  width: 100%;
  height: auto;
  display: block;
}

.node-link {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: transparent;
  border: 1px solid var(--lore-color, #28A8D6);
  color: var(--lore-color, #28A8D6);
  font-weight: 700;
  font-size: 0.875rem;
  text-transform: uppercase;
  text-decoration: none;
  border-radius: 6px;
  transition: all 0.3s ease;
  align-self: flex-start;
  position: relative;
  z-index: 1;
}

.node-link:hover {
  background: var(--lore-color, #28A8D6);
  color: #000;
  transform: translateX(4px);
}

.node-divider {
  width: 100%;
  height: 20px;
  color: var(--lore-color, #28A8D6);
  margin: 2rem 0;
}

@media (max-width: 768px) {
  .node-trigger {
    padding: 1.25rem 1.5rem;
    font-size: 0.875rem;
  }
  
  .trigger-content {
    gap: 0.75rem;
  }
  
  .content-inner {
    padding: 1.5rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const nodes = document.querySelectorAll('[data-lore-node]');
  
  nodes.forEach(node => {
    const trigger = node.querySelector('[data-node-trigger]');
    const content = node.querySelector('[data-node-content]');
    
    if (!trigger || !content) return;
    
    trigger.addEventListener('click', () => {
      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
      
      // Close all other nodes (accordion behavior)
      nodes.forEach(otherNode => {
        if (otherNode !== node) {
          const otherTrigger = otherNode.querySelector('[data-node-trigger]');
          if (otherTrigger) {
            otherTrigger.setAttribute('aria-expanded', 'false');
          }
        }
      });
      
      // Toggle current node
      trigger.setAttribute('aria-expanded', !isExpanded);
      
      // Smooth scroll into view if opening
      if (!isExpanded) {
        setTimeout(() => {
          trigger.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);
      }
    });
  });
});
</script>

{% schema %}
{
  "name": "Lore Accordion",
  "tag": "section",
  "class": "stellar-lore-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Fractured Narratives"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Expand the nodes. Decode the transmissions."
    },
    {
      "type": "color",
      "id": "lore_color",
      "label": "Accent Color",
      "default": "#28A8D6"
    }
  ],
  "blocks": [
    {
      "type": "lore_node",
      "name": "Lore Node",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Node Title",
          "default": "The First Transmission"
        },
        {
          "type": "text",
          "id": "node_number",
          "label": "Node Number",
          "default": "001",
          "info": "Optional identifier"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<p>Deep within the void, signals emerge. Each transmission carries fragments of the greater truth...</p>"
        },
        {
          "type": "text",
          "id": "audio_url",
          "label": "Audio URL",
          "info": "Optional audio file URL (MP3 recommended)"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Optional Image"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "Link URL"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link Text",
          "default": "Explore Further"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Lore Accordion",
      "category": "Stellar Reverb",
      "blocks": [
        {
          "type": "lore_node"
        },
        {
          "type": "lore_node"
        },
        {
          "type": "lore_node"
        }
      ]
    }
  ]
}
{% endschema %}