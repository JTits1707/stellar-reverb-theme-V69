{% comment %}
  =====================================================
  FLOATING ARCHIVE ACCESS GATE (Beast Mode)
  =====================================================
  - Fixed duplicate script signals
  - Integrated "Shatter" Breach animation
  - Unified Access Handshake (Tags + Metafields)
{% endcomment %}

{%- liquid
  assign gate_title = section.settings.gate_title | default: 'ACCESS RESTRICTED'
  assign gate_message = section.settings.gate_message | default: 'This archive is reserved for Signal Seekers only.'
  assign gate_cta = section.settings.gate_cta | default: 'Verify Access'
  assign subscribe_url = section.settings.subscribe_url | default: '/pages/transmission-archive#klaviyo-signup'
  
  assign has_access = false
  assign access_override = false
  
  # Check URL parameter for testing
  if request.url contains '?access=granted' or request.url contains '&access=granted'
    assign access_override = true
  endif
  
  # Check customer authorization status [cite: 91, 144]
  if customer
    if customer.tags contains 'signal_seeker' or customer.tags contains 'floating_archive_access' or customer.tags contains 'signal-seeker'
      assign has_access = true
    endif
    
    if customer.metafields.access.floating_archive == true or customer.metafields.access.floating_archive == 'true'
      assign has_access = true
    endif
  endif
  
  if has_access or access_override
    assign show_gate = false
  else
    assign show_gate = true
  endif
-%}

{% if show_gate %}
<div class="floating-archive-gate" id="archiveGate-{{ section.id }}" data-section-id="{{ section.id }}">
  <div class="gate-overlay"></div>
  
  <div class="gate-container">
    <div class="gate-hologram">
      <div class="hologram-frame"></div>
      
      <div class="gate-content">
        <div class="gate-icon">
          <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
            <rect x="10" y="30" width="60" height="40" stroke="currentColor" stroke-width="2" fill="none"/>
            <circle cx="40" cy="50" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M40 20 L40 30" stroke="currentColor" stroke-width="2"/>
          </svg>
        </div>
        
        <h1 class="gate-title glitch-text" data-text="{{ gate_title }}">
          {{ gate_title }}
        </h1>
        
        <div class="gate-system-text">
          <p class="terminal-line">>> AUTHENTICATION REQUIRED</p>
          <p class="terminal-line">>> SIGNAL SEEKER STATUS: <span class="status-denied">UNVERIFIED</span></p>
          <p class="terminal-line">>> ACCESS LEVEL: <span class="status-denied">INSUFFICIENT</span></p>
        </div>
        
        <p class="gate-message">{{ gate_message }}</p>
        
        <div class="gate-actions">
          {% if customer %}
            <p class="gate-info">System ID: <strong>{{ customer.email }}</strong> // Clearance: Restricted</p>
            <a href="{{ subscribe_url }}" class="gate-btn primary">Elevate Clearance</a>
          {% else %}
            <a href="/account/login?return_url={{ request.path }}" class="gate-btn primary">{{ gate_cta }}</a>
            <a href="{{ subscribe_url }}" class="gate-btn secondary">Become a Signal Seeker</a>
          {% endif %}
        </div>
        
        <div class="gate-footer">
          <a href="/pages/transmission-archive" class="gate-link">‚Üê Return to Public Terminal</a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .floating-archive-gate {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 99999;
    display: flex; align-items: center; justify-content: center;
  }
  
  .gate-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #000000; opacity: 0.98;
  }
  
  .gate-container {
    position: relative; z-index: 2; max-width: 600px; width: 90%;
    animation: gateReveal 0.8s ease-out;
  }
  
  .gate-hologram {
    position: relative;
    background: linear-gradient(135deg, rgba(0, 10, 20, 0.9) 0%, rgba(10, 0, 20, 0.9) 100%);
    border: 2px solid rgba(40, 168, 214, 0.5);
    border-radius: 8px;
    padding: 3rem 2rem;
    box-shadow: 0 0 50px rgba(40, 168, 214, 0.3);
  }

  /* --- BEAST MODE: SHATTER ANIMATION --- */
  .sr-gate-shatter {
    animation: gateShatter 0.8s cubic-bezier(0.7, 0, 0.3, 1) forwards;
    pointer-events: none;
  }

  @keyframes gateShatter {
    0% { opacity: 1; filter: brightness(1) contrast(1); }
    40% { opacity: 0.8; filter: brightness(2) contrast(2) hue-rotate(90deg); transform: scale(1.05); }
    100% { opacity: 0; filter: brightness(5); transform: scale(1.2) translateY(-20px); }
  }

  .terminal-line { color: #00F0AC; font-family: monospace; font-size: 0.9rem; }
  .status-denied { color: #E13CFA; font-weight: bold; }
  
  @keyframes gateReveal {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
</style>
#archiveGate-{{ section.id }} {
  display: none; /* Keep hidden for Konami secret */
  pointer-events: all;

<script>
document.addEventListener('DOMContentLoaded', function() {
  const gate = document.getElementById('archiveGate-{{ section.id }}');
  const verifyBtn = gate?.querySelector('.gate-btn.primary');
  
  // Disable scroll when gate is active 
  if (gate) { document.body.style.overflow = 'hidden'; }

  if (verifyBtn) {
    verifyBtn.addEventListener('click', function(e) {
      // If user has access (Liquid check), trigger the shatter breach
      {% if has_access or access_override %}
        e.preventDefault();
        gate.classList.add('sr-gate-shatter');
        
        setTimeout(() => {
          gate.style.display = 'none';
          document.body.style.overflow = '';
          document.body.classList.add('floating-archive-active');
        }, 800);
      {% endif %}
    });
  }
});
</script>
{% endif %}

{% schema %}
{
  "name": "Floating Archive Gate",
  "settings": [
    { "type": "text", "id": "gate_title", "label": "Gate Title", "default": "ACCESS RESTRICTED" },
    { "type": "textarea", "id": "gate_message", "label": "Gate Message", "default": "Reserved for verified Signal Seekers." },
    { "type": "text", "id": "gate_cta", "label": "CTA Text", "default": "Verify Access" },
    { 
      "type": "url", 
      "id": "subscribe_url", 
      "label": "Subscribe URL",
      "info": "Leave empty to use the default transmission-archive path."
    }
  ]
}
{% endschema %}