{% comment %}
Section: Transmission Vault (Shop-all)
- Filter bar (tags/type/vendor) and sort
- Grid of capsules (products from transmissions)
- FOMO: low-stock, “last X left”, “viewing now” microcopy (JS-simulated unless you supply real-time)
TODO: Replace filter UI with your shop-all section HTML snippet if you want exact parity.
{% endcomment %}

<section class="vault">
  <div class="wrap grid" style="gap:16px">
    <h2 class="title-cap" style="font-size:clamp(18px,3.3vw,28px);font-weight:800;color:var(--magenta)">Vault</h2>

    <form class="grid" style="gap:10px" method="get" action="{{ routes.all_products_collection_url | default: routes.root_url }}">
      <div class="grid" style="gap:8px">
        <label class="sr-only" for="q-sort">Sort</label>
        <select id="q-sort" name="sort_by" style="background:#120018;border:1px solid #2a0034;color:var(--ink);padding:.6rem;border-radius:10px">
          <option value="created-descending">Newest</option>
          <option value="price-ascending">Price: Low to High</option>
          <option value="price-descending">Price: High to Low</option>
          <option value="best-selling">Best selling</option>
        </select>
      </div>
      <div class="grid" style="gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))">
        <div>
          <label class="sr-only" for="q-type">Type</label>
          <input id="q-type" name="q" placeholder="Filter type/tag (e.g., 'cassette')" style="width:100%;background:#120018;border:1px solid #2a0034;color:var(--ink);padding:.6rem;border-radius:10px">
        </div>
        <button class="btn" type="submit">Apply</button>
      </div>
    </form>

    {%- assign col = collections['transmissions'] -%}
    {% if col and col.products_count > 0 %}
      <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:clamp(12px,2vw,18px)">
        {% for product in col.products %}
          <article class="card">
            <a href="{{ product.url }}" style="text-decoration:none;color:inherit">
              {%- assign img = product.featured_image -%}
              {% if img %}
                <img src="{{ img | image_url: width: 660 }}" alt="{{ img.alt | escape }}"
                     width="660" height="{{ 660 | divided_by: img.aspect_ratio | round }}"
                     loading="lazy" style="border-radius:12px">
              {% endif %}

              <div class="grid" style="gap:6px">
                <strong>{{ product.title }}</strong>
                {%- assign teaser = product.metafields.custom.teaser -%}
                {% if teaser != blank %}
                  <p style="color:var(--mute)">{{ teaser }}</p>
                {% endif %}
              </div>

              {%- if product.available -%}
                {%- assign v = product.selected_or_first_available_variant -%}
                {%- if v.inventory_management and v.inventory_quantity != nil and v.inventory_quantity <= 5 -%}
                  <div class="fomo">Last {{ v.inventory_quantity }} left</div>
                {%- endif -%}
              {%- else -%}
                <div class="fomo">Sold out — archive pending</div>
              {%- endif -%}
            </a>

            <div class="grid" style="grid-auto-flow:column;justify-content:flex-start;gap:8px;align-items:center">
              <a class="btn" href="{{ product.url }}">Open</a>
              {% if product.available %}
                <form method="post" action="/cart/add">
                  <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                  <button class="btn" type="submit">Add</button>
                </form>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p style="color:var(--mute)">Nothing in the vault yet. Add products to the “transmissions” collection.</p>
    {% endif %}
  </div>
</section>

<script>
  // Faux “viewing now” count to induce gentle FOMO; replace with your analytics if desired.
  (function(){
    const cards = document.querySelectorAll('.vault .card');
    cards.forEach((c,i)=>{
      if(Math.random() > .4) {
        const v = Math.floor(Math.random()*3)+1;
        const el = document.createElement('div');
        el.className='fomo';
        el.textContent = v + (v>1?' people are':' person is') + ' viewing';
        c.appendChild(el);
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Transmission Vault (Shop-all)",
  "settings": [],
  "presets": [{ "name": "Transmission Vault" }]
}
{% endschema %}