{% comment %}
  STELLAR REVERB - Transmission Grid (CORRECTED)
  
  Works with: shop.metaobjects.capsule_archive.values
  Compatible with: Notion → Make.com → Shopify workflow
  
  Your metaobject fields:
  - capsule_number
  - title  
  - theme_color
  - featured_image
  - page_url
  - release_date
  - description
{% endcomment %}

{% liquid
  assign all_capsules = shop.metaobjects.capsule_archive.values
  assign grid_columns = section.settings.grid_columns | default: 3
  assign enable_filter = section.settings.enable_theme_filter | default: true
  assign default_sort = section.settings.default_sort | default: 'number_asc'
  
  case default_sort
    when 'number_asc'
      assign sorted_capsules = all_capsules | sort: 'capsule_number'
    when 'number_desc'
      assign sorted_capsules = all_capsules | sort: 'capsule_number' | reverse
    when 'date_desc'
      assign sorted_capsules = all_capsules | sort: 'release_date' | reverse
    when 'date_asc'
      assign sorted_capsules = all_capsules | sort: 'release_date'
    else
      assign sorted_capsules = all_capsules
  endcase
  
  assign available_themes = ''
  for capsule in all_capsules
    assign theme = capsule.theme_color.value | default: 'default'
    unless available_themes contains theme
      assign available_themes = available_themes | append: theme | append: ','
    endunless
  endfor
  assign theme_array = available_themes | split: ','
%}

<style>
  .stellar-transmission-grid {
    padding: 6rem 2rem;
    background: linear-gradient(180deg, #0a0a0a 0%, #0d0516 100%);
    position: relative;
  }

  .stellar-transmission-grid__container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .stellar-transmission-grid__header {
    text-align: center;
    margin-bottom: 4rem;
  }

  .stellar-transmission-grid__title {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 900;
    color: #E13CFA;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin-bottom: 2rem;
    text-shadow: 0 0 30px rgba(225, 60, 250, 0.6);
  }

  .stellar-transmission-grid__controls {
    display: flex;
    gap: 2rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 3rem;
  }

  .stellar-transmission-grid__filter,
  .stellar-transmission-grid__sort {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .stellar-transmission-grid__filter label,
  .stellar-transmission-grid__sort label {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.875rem;
    color: #28A8D6;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stellar-transmission-grid__select {
    padding: 0.75rem 1.5rem;
    background: rgba(40, 168, 214, 0.1);
    border: 1px solid #28A8D6;
    color: #C0C0C0;
    border-radius: 6px;
    font-family: 'PP Mori', sans-serif;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .stellar-transmission-grid__select:hover,
  .stellar-transmission-grid__select:focus {
    background: rgba(40, 168, 214, 0.2);
    outline: none;
  }

  .stellar-transmission-grid__grid {
    display: grid;
    grid-template-columns: repeat({{ grid_columns }}, 1fr);
    gap: 3rem;
  }

  @media (max-width: 1024px) {
    .stellar-transmission-grid__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .stellar-transmission-grid {
      padding: 3rem 1rem;
    }
    
    .stellar-transmission-grid__grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    
    .stellar-transmission-grid__controls {
      flex-direction: column;
      gap: 1rem;
    }
  }

  /* CAPSULE CARD STYLES */
  .stellar-capsule {
    position: relative;
    background: rgba(10, 10, 10, 0.8);
    border: 2px solid #E13CFA;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.4s ease;
    cursor: pointer;
  }

  .stellar-capsule:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 60px rgba(225, 60, 250, 0.4);
    border-color: #28A8D6;
  }

  .stellar-capsule__image-wrapper {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
  }

  .stellar-capsule__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s ease;
  }

  .stellar-capsule:hover .stellar-capsule__image {
    transform: scale(1.1);
  }

  .stellar-capsule__content {
    padding: 1.5rem;
  }

  .stellar-capsule__number {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.875rem;
    color: #28A8D6;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 0.5rem;
  }

  .stellar-capsule__title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.5rem;
    font-weight: 700;
    color: #C0C0C0;
    margin-bottom: 1rem;
    text-transform: uppercase;
    line-height: 1.3;
  }

  .stellar-capsule__title a {
    color: inherit;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .stellar-capsule__title a:hover {
    color: #E13CFA;
  }

  .stellar-capsule__description {
    color: #C0C0C0;
    font-family: 'PP Mori', sans-serif;
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 1rem;
    opacity: 0.9;
  }

  .stellar-capsule__meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .stellar-capsule__theme {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: rgba(40, 168, 214, 0.1);
    border: 1px solid #28A8D6;
    color: #28A8D6;
    border-radius: 6px;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stellar-capsule__date {
    font-size: 0.875rem;
    color: #C0C0C0;
    opacity: 0.7;
  }

  /* EMPTY STATE */
  .stellar-transmission-grid__empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
    color: #C0C0C0;
  }

  .stellar-transmission-grid__empty-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 1rem;
    opacity: 0.3;
  }
</style>

<section class="stellar-transmission-grid" data-section-id="{{ section.id }}">
  <div class="stellar-transmission-grid__container">
    
    <div class="stellar-transmission-grid__header">
      <h2 class="stellar-transmission-grid__title">
        {{ section.settings.section_title }}
      </h2>

      {% if enable_filter and theme_array.size > 1 %}
        <div class="stellar-transmission-grid__controls">
          <div class="stellar-transmission-grid__filter">
            <label for="theme-filter-{{ section.id }}">Filter:</label>
            <select id="theme-filter-{{ section.id }}" class="stellar-transmission-grid__select" data-theme-filter>
              <option value="all">All Themes</option>
              {% for theme in theme_array %}
                {% if theme != blank %}
                  <option value="{{ theme }}">{{ theme | replace: '-', ' ' | capitalize }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="stellar-transmission-grid__sort">
            <label for="sort-select-{{ section.id }}">Sort:</label>
            <select id="sort-select-{{ section.id }}" class="stellar-transmission-grid__select" data-sort-select>
              <option value="number_asc">Number (Low to High)</option>
              <option value="number_desc">Number (High to Low)</option>
              <option value="date_desc">Newest First</option>
              <option value="date_asc">Oldest First</option>
            </select>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="stellar-transmission-grid__grid" data-capsule-grid>
      {% if sorted_capsules.size > 0 %}
        {% for capsule in sorted_capsules %}
          <article 
            class="stellar-capsule" 
            data-capsule-number="{{ capsule.capsule_number.value }}"
            data-theme="{{ capsule.theme_color.value | default: 'default' }}"
          >
            
            <div class="stellar-capsule__image-wrapper">
              {% if capsule.featured_image %}
                <img 
                  class="stellar-capsule__image" 
                  src="{{ capsule.featured_image | image_url: width: 800 }}"
                  alt="{{ capsule.title.value }}"
                  loading="lazy"
                  width="800"
                  height="600"
                >
              {% endif %}
            </div>

            <div class="stellar-capsule__content">
              <div class="stellar-capsule__number">
                CAPSULE {{ capsule.capsule_number.value }}
              </div>

              <h3 class="stellar-capsule__title">
                <a href="{{ capsule.page_url.value }}">
                  {{ capsule.title.value }}
                </a>
              </h3>

              {% if capsule.description.value %}
                <p class="stellar-capsule__description">
                  {{ capsule.description.value | strip_html | truncate: 120 }}
                </p>
              {% endif %}

              <div class="stellar-capsule__meta">
                {% if capsule.theme_color.value %}
                  <span class="stellar-capsule__theme">
                    {{ capsule.theme_color.value | replace: '-', ' ' }}
                  </span>
                {% endif %}

                {% if capsule.release_date.value %}
                  <span class="stellar-capsule__date">
                    {{ capsule.release_date.value | date: "%B %Y" }}
                  </span>
                {% endif %}
              </div>
            </div>
          </article>
        {% endfor %}
      {% else %}
        <div class="stellar-transmission-grid__empty">
          <svg class="stellar-transmission-grid__empty-icon" viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="32" cy="32" r="28"/>
            <path d="M20 32h24M32 20v24"/>
          </svg>
          <h3>No Transmissions Found</h3>
          <p>Create a capsule in Notion to see it appear here via Make.com automation!</p>
        </div>
      {% endif %}
    </div>

  </div>
</section>

<script>
  // FILTER & SORT FUNCTIONALITY
  (function() {
    const grid = document.querySelector('[data-capsule-grid]');
    const themeFilter = document.querySelector('[data-theme-filter]');
    const sortSelect = document.querySelector('[data-sort-select]');

    if (!grid) return;

    function filterAndSort() {
      const capsules = Array.from(grid.querySelectorAll('.stellar-capsule'));
      const selectedTheme = themeFilter ? themeFilter.value : 'all';
      const selectedSort = sortSelect ? sortSelect.value : 'number_asc';

      // Filter
      capsules.forEach(capsule => {
        const theme = capsule.dataset.theme || 'default';
        if (selectedTheme === 'all' || theme === selectedTheme) {
          capsule.style.display = '';
        } else {
          capsule.style.display = 'none';
        }
      });

      // Sort
      const visibleCapsules = capsules.filter(c => c.style.display !== 'none');
      visibleCapsules.sort((a, b) => {
        const aNum = a.dataset.capsuleNumber || '000';
        const bNum = b.dataset.capsuleNumber || '000';
        
        switch(selectedSort) {
          case 'number_asc':
            return aNum.localeCompare(bNum);
          case 'number_desc':
            return bNum.localeCompare(aNum);
          default:
            return 0;
        }
      });

      // Reorder
      visibleCapsules.forEach(capsule => grid.appendChild(capsule));
    }

    if (themeFilter) themeFilter.addEventListener('change', filterAndSort);
    if (sortSelect) sortSelect.addEventListener('change', filterAndSort);
  })();
</script>

{% schema %}
{
  "name": "Transmission Grid (Corrected)",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "TRANSMISSION ARCHIVE"
    },
    {
      "type": "range",
      "id": "grid_columns",
      "label": "Grid Columns (Desktop)",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 3
    },
    {
      "type": "checkbox",
      "id": "enable_theme_filter",
      "label": "Enable Theme Filter",
      "default": true
    },
    {
      "type": "select",
      "id": "default_sort",
      "label": "Default Sort Order",
      "options": [
        { "value": "number_asc", "label": "Number (Low to High)" },
        { "value": "number_desc", "label": "Number (High to Low)" },
        { "value": "date_desc", "label": "Newest First" },
        { "value": "date_asc", "label": "Oldest First" }
      ],
      "default": "number_asc"
    }
  ],
  "presets": [
    {
      "name": "Transmission Grid (Corrected)"
    }
  ]
}
{% endschema %}