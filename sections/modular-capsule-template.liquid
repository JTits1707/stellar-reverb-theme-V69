{% comment %}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STELLAR REVERB â€” MODULAR CAPSULE SECTION V2.0 FINAL (FIXED)
Supreme-level craft meets cosmic storytelling
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{% endcomment %}

{%- liquid
  assign theme_color = section.settings.theme_color | default: 'neon-magenta'
  assign capsule_num = section.settings.capsule_number | default: '004'
  assign capsule_name = section.settings.capsule_name | default: 'UNTITLED TRANSMISSION'
-%}

{%- comment -%} Load Stylesheet with Performance Best Practices  {%- endcomment -%}
<link rel="stylesheet" href="{{ 'modular-capsule-styles.css' | asset_url }}" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="{{ 'modular-capsule-styles.css' | asset_url }}"></noscript>

<section 
  class="capsule-transmission" 
  data-capsule-id="{{ capsule_num }}" 
  data-theme="{{ theme_color }}"
  style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;"
>
  
  {%- comment -%} Cosmic Backdrop [cite: 185] {%- endcomment -%}
  <div class="cosmic-backdrop">
    <div class="cosmic-gradient"></div>
    <div class="constellation-grid">
      {% for i in (1..12) %}
        <div class="constellation-dot" style="top: {{ i | times: 7 | modulo: 100 }}%; left: {{ i | times: 13 | modulo: 100 }}%; animation-delay: {{ i | times: 0.5 }}s;"></div>
      {% endfor %}
    </div>
  </div>

  <div class="container">
    {%- comment -%} Header Section [cite: 188] {%- endcomment -%}
    <header class="capsule-header">
      <div class="capsule-meta">
        <span class="capsule-id">TRANSMISSION {{ capsule_num }}</span>
        {% if section.settings.release_date != blank %}
          <span class="capsule-date">{{ section.settings.release_date }}</span>
        {% endif %}
        <span class="capsule-status {% if section.settings.is_active %}active{% else %}inactive{% endif %}">
          {% if section.settings.is_active %}<span class="status-pulse"></span> ACTIVE SIGNAL{% else %}ARCHIVED{% endif %}
        </span>
      </div>
      
      <h1 class="capsule-title glitch-text" data-text="{{ capsule_name | upcase }}">
        {{ capsule_name | upcase }}
      </h1>
      
      {% if section.settings.tagline != blank %}
        <p class="capsule-tagline">{{ section.settings.tagline }}</p>
      {% endif %}
    </header>

    {%- comment -%} Hero Image with Fixed Attributes [cite: 189] {%- endcomment -%}
    {% if section.settings.main_image != blank %}
      <div class="capsule-hero-image-wrapper">
        <div class="image-container">
          <img 
            src="{{ section.settings.main_image | image_url: width: 1400 }}" 
            alt="{{ capsule_name | escape }}"
            width="{{ section.settings.main_image.width | default: 1400 }}"
            height="{{ section.settings.main_image.height | default: 800 }}"
            class="capsule-hero-image"
            loading="eager"
          >
          <div class="image-overlay"></div>
          <div class="scanline-effect"></div>
        </div>
        {% if section.settings.image_caption != blank %}
          <p class="image-caption">{{ section.settings.image_caption }}</p>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Transmission Log & Audio [cite: 191] {%- endcomment -%}
    {% if section.settings.lore_intro != blank %}
      <div class="capsule-lore">
        <h2 class="lore-title"><span class="title-icon">ğŸ“¡</span> Transmission Log</h2>
        <div class="lore-content rte">{{ section.settings.lore_intro }}</div>
        
        {% if section.settings.ambient_audio != blank %}
          <div class="ambient-player">
            <button class="audio-toggle" aria-label="Toggle ambient audio">
              <span class="audio-icon paused">ğŸ”Š</span>
              <span class="audio-icon playing" style="display:none;">ğŸ”‡</span>
              <span class="audio-label">Ambient Frequency</span>
              <span class="audio-visualizer">
                <span class="audio-bar"></span>
                <span class="audio-bar"></span>
                <span class="audio-bar"></span>
              </span>
            </button>
            <audio src="{{ section.settings.ambient_audio }}" loop preload="none"></audio>
          </div>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Relics Grid [cite: 194] {%- endcomment -%}
    {% assign product_blocks = section.blocks | where: 'type', 'product' %}
    {% if product_blocks.size > 0 %}
      <div class="capsule-products">
        <h2 class="products-title"><span class="title-glyph">ğŸ“¼</span> Relics from this Transmission</h2>
        <div class="products-grid">
          {% for block in product_blocks %}
            {% assign prod = block.settings.product %}
            {% if prod != blank %}
              <div class="product-wrapper">
                {% render 'product-card-cosmic', product: prod, capsule_number: capsule_num %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {%- comment -%} Lore Fragments [cite: 198] {%- endcomment -%}
    {% assign lore_blocks = section.blocks | where: 'type', 'lore_fragment' %}
    {% if lore_blocks.size > 0 %}
      <div class="capsule-lore-fragments">
        <h2 class="fragments-title"><span class="title-glyph">ğŸ”®</span> Decoded Fragments</h2>
        <div class="fragments-grid">
          {% for block in lore_blocks %}
            <div class="lore-fragment fade-in-up">
              <div class="fragment-header">
                <div class="fragment-id">{{ block.settings.fragment_id }}</div>
                <h3 class="fragment-title">{{ block.settings.fragment_title }}</h3>
              </div>
              <div class="fragment-content rte">{{ block.settings.fragment_content }}</div>
              <div class="fragment-glow"></div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
</section>

{%- comment -%} Schema with Corrected Syntax [cite: 222] {%- endcomment -%}
{% schema %}
{
  "name": "Modular Capsule",
  "settings": [
    { "type": "header", "content": "ğŸ›¸ Capsule Identity" },
    { "type": "text", "id": "capsule_number", "label": "Capsule #", "default": "004" },
    { "type": "text", "id": "capsule_name", "label": "Capsule Name", "default": "THE MACHINE THAT DREAMED" },
    { "type": "textarea", "id": "tagline", "label": "Tagline" },
    { "type": "checkbox", "id": "is_active", "label": "Active Signal", "default": true },
    { "type": "text", "id": "release_date", "label": "Release Date" },
    { "type": "header", "content": "ğŸ¨ Theme & Colors" },
    { "type": "select", "id": "theme_color", "label": "Color Theme", "default": "neon-magenta",
      "options": [
        { "value": "neon-magenta", "label": "Neon Magenta" },
        { "value": "cyber-cyan", "label": "Cyber Cyan" },
        { "value": "toxic-green", "label": "Toxic Green" },
        { "value": "electric-purple", "label": "Electric Purple" },
        { "value": "solar-orange", "label": "Solar Orange" },
        { "value": "arctic-blue", "label": "Arctic Blue" },
        { "value": "blood-red", "label": "Blood Red" },
        { "value": "void-silver", "label": "Void Silver" }
      ]
    },
    { "type": "header", "content": "ğŸ–¼ï¸ Visual Assets" },
    { "type": "image_picker", "id": "main_image", "label": "Hero Image" },
    { "type": "text", "id": "image_caption", "label": "Caption" },
    { "type": "url", "id": "ambient_audio", "label": "Audio URL (MP3)" },
    { "type": "header", "content": "ğŸ“– Lore & Story" },
    { "type": "richtext", "id": "lore_intro", "label": "Transmission Log" },
    { "type": "header", "content": "âš™ï¸ Spacing" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 160, "step": 10, "unit": "px", "label": "Top", "default": 80 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 160, "step": 10, "unit": "px", "label": "Bottom", "default": 80 }
  ],
  "blocks": [
    { "type": "product", "name": "ğŸ“¼ Relic", "settings": [{ "type": "product", "id": "product", "label": "Product" }] },
    { "type": "lore_fragment", "name": "ğŸ”® Fragment", "settings": [
        { "type": "text", "id": "fragment_id", "label": "ID", "default": "A" },
        { "type": "text", "id": "fragment_title", "label": "Title" },
        { "type": "richtext", "id": "fragment_content", "label": "Content" }
    ]}
  ],
  "presets": [{ "name": "ğŸŒŸ Modular Capsule" }]
}
{% endschema %}