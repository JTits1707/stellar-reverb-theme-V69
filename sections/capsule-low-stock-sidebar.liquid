{% comment %}
  Section: capsule-lowstock-sidebar.liquid (v1)
  Purpose: Compact low-stock sidebar for Capsule pages
  Notes: Reuses snippets/product-card.liquid with a compact style wrapper.
{% endcomment %}

<aside class="sr-capsule-sidebar sr-container" aria-labelledby="capsule-lowstock-title-{{ section.id }}">
  <h3 id="capsule-lowstock-title-{{ section.id }}" class="sr-capsule-sidebar__title">{{ section.settings.heading | default: 'Fading Signals' }}</h3>
  {%- if section.settings.subheading != blank -%}
    <p class="sr-capsule-sidebar__sub">{{ section.settings.subheading }}</p>
  {%- endif -%}

  {%- assign coll = section.settings.collection -%}
  {%- if coll == blank -%}
    <div class="sr-capsule-sidebar__empty">
      <p>Select a collection (e.g., your <code>low-stock</code> smart collection).</p>
    </div>
  {%- else -%}
    {%- assign max_items = section.settings.products_to_show | default: 4 -%}
    <div class="sr-capsule-sidebar__list sr-compact">
      {%- for product in coll.products limit: max_items -%}
        {% render 'product-card',
          product: product,
          low_stock_threshold: section.settings.low_stock_threshold | default: settings.low_stock_threshold | default: 5,
          show_total_low_stock: section.settings.show_total_low_stock | default: true
        %}
      {%- else -%}
        <div class="sr-capsule-sidebar__empty">
          <p>No items are currently low on stock.</p>
        </div>
      {%- endfor -%}
    </div>
  {%- endif -%}

  {%- if section.settings.show_view_all and section.settings.view_all_link != blank -%}
    <div class="sr-capsule-sidebar__cta">
      <a class="sr-capsule-sidebar__link" href="{{ section.settings.view_all_link }}">View all low-stock</a>
    </div>
  {%- endif -%}
</aside>

<style>
/* Layout suitable for sidebar columns */
.sr-capsule-sidebar { padding: 16px; background: rgba(15,15,25,.6); border:1px solid #2a2a40; border-radius:10px; }
.sr-capsule-sidebar__title { margin:0 0 6px; font-family:'Orbitron','Exo 2',sans-serif; font-size:1.1rem; background: linear-gradient(45deg, var(--sr-magenta,#E13CFA), var(--sr-cyan,#28A8D6)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.sr-capsule-sidebar__sub { margin:0 0 10px; opacity:.85; font-size:.95rem; }
.sr-capsule-sidebar__list { display:grid; gap:10px; }
.sr-capsule-sidebar__cta { text-align:center; margin-top:10px; }
.sr-capsule-sidebar__link { display:inline-block; padding:8px 12px; border-radius:999px; text-decoration:none; color:#fff; background: linear-gradient(45deg, var(--sr-magenta,#E13CFA), var(--sr-cyan,#28A8D6)); }
.sr-capsule-sidebar__empty { padding:10px; background: rgba(15,15,25,.4); border:1px dashed #2a2a40; border-radius:8px; }

/* Compact mode tweaks for product-card snippet */
.sr-compact .sr-product-card { padding:10px; flex-direction:row; gap:10px; }
.sr-compact .sr-card-image { width: 84px; flex: 0 0 84px; }
.sr-compact .sr-card-image img { border-radius:6px; }
.sr-compact .sr-card-info { display:flex; flex-direction:column; gap:6px; }
.sr-compact .sr-card-title { font-size:.95rem; line-height:1.2; }
.sr-compact .sr-price-row { gap:8px; }
.sr-compact .sr-price { font-size:.95rem; }
.sr-compact .sr-compare { font-size:.85rem; }
.sr-compact .badge-low, .sr-compact .badge-sale { font-size:.65rem; padding:2px 6px; }
</style>

{% schema %}
{
  "name": "Capsule Low-stock Sidebar",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Fading Signals" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Relics slipping beyond the event horizon." },
    { "type": "collection", "id": "collection", "label": "Low-stock collection" },
    { "type": "range", "id": "products_to_show", "label": "Products to show", "min": 2, "max": 8, "step": 1, "default": 4 },
    { "type": "range", "id": "low_stock_threshold", "label": "Low-stock threshold (override)", "min": 1, "max": 25, "step": 1, "default": 5 },
    { "type": "checkbox", "id": "show_total_low_stock", "label": "Show total-across-variants badge", "default": true },
    { "type": "checkbox", "id": "show_view_all", "label": "Show view-all button", "default": true },
    { "type": "url", "id": "view_all_link", "label": "View-all link" }
  ],
  "presets": [ { "name": "Capsule Low-stock Sidebar", "category": "Promotional" } ]
}
{% endschema %}