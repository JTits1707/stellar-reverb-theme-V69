{% assign all_capsules = metaobjects.capsule.values %}

{% assign prime_capsules      = all_capsules | where: 'timeline_track', 'prime'      | sort: 'timeline_order' %}
{% assign lunar_capsules      = all_capsules | where: 'timeline_track', 'lunar'      | sort: 'timeline_order' %}
{% assign singularity_capsules= all_capsules | where: 'timeline_track', 'singularity'| sort: 'timeline_order' %}
{% assign hidden_capsules     = all_capsules | where: 'timeline_track', 'hidden'     | sort: 'timeline_order' %}{% comment %}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SECTION: Live Signal Feed (X/Twitter Integration)
  Features: Real-time semantic search, dynamic feed updates, community engagement
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{% endcomment %}

<section class="lore-signals" id="signals">
  <h2 class="lore-signals__title orbitron">{{ section.settings.section_title }}</h2>
  <p class="lore-signals__subtitle montserrat">{{ section.settings.subtitle }}</p>
  
  <div class="signal-feed" id="signalFeed">
    {% comment %} === STATIC SIGNALS (Fallback) === {% endcomment %}
    {% for block in section.blocks %}
      <div class="signal-item" data-signal-type="{{ block.settings.signal_type }}">
        <div class="signal-header">
          <div class="signal-avatar" style="background: linear-gradient(135deg, {{ block.settings.avatar_color_1 }}, {{ block.settings.avatar_color_2 }});">
            {{ block.settings.username | slice: 0, 2 | upcase }}
          </div>
          <span class="signal-user orbitron">{{ block.settings.username }}</span>
          <span class="signal-timestamp">{{ block.settings.timestamp }}</span>
        </div>
        <div class="signal-content">{{ block.settings.content }}</div>
        <div class="signal-hashtags">
          {% assign hashtags = block.settings.hashtags | split: ',' %}
          {% for tag in hashtags %}
            <span class="hashtag">{{ tag | strip }}</span>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
  
  {% if section.settings.enable_live_feed %}
    <div class="signal-refresh">
      <button class="refresh-btn" onclick="refreshSignals()" aria-label="Refresh signals">
        <span class="refresh-icon">âŸ³</span>
        <span>REFRESH SIGNALS</span>
      </button>
    </div>
  {% endif %}
</section>

<style>
  .lore-signals {
    padding: 10rem 2rem;
    background: linear-gradient(135deg, #0D0D0D, #0A0A0A);
    position: relative;
    overflow: hidden;
  }
  
  .lore-signals__title {
    font-size: clamp(2rem, 4vw, 3.5rem);
    color: #F4FF30;
    text-align: center;
    margin-bottom: 2rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    text-shadow: 0 0 20px currentColor;
  }
  
  .lore-signals__subtitle {
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
    font-size: clamp(0.875rem, 1.2vw, 1rem);
    margin-bottom: 6rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .signal-feed {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .signal-item {
    background: rgba(26, 26, 26, 0.8);
    border: 1px solid rgba(244, 255, 48, 0.3);
    border-radius: 12px;
    padding: 2rem;
    position: relative;
    overflow: hidden;
    transform: translateX(-50px);
    opacity: 0;
    animation: signal-appear 0.8s ease-out forwards;
    transition: all 0.3s ease;
  }
  
  .signal-item:hover {
    border-color: rgba(244, 255, 48, 0.6);
    transform: translateX(0) translateY(-4px);
    box-shadow: 0 8px 32px rgba(244, 255, 48, 0.2);
  }
  
  .signal-item:nth-child(1) { animation-delay: 0.1s; }
  .signal-item:nth-child(2) { animation-delay: 0.3s; }
  .signal-item:nth-child(3) { animation-delay: 0.5s; }
  .signal-item:nth-child(4) { animation-delay: 0.7s; }
  .signal-item:nth-child(5) { animation-delay: 0.9s; }
  
  @keyframes signal-appear {
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  .signal-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, #F4FF30, #00F0AC);
  }
  
  .signal-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .signal-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #E13CFA, #28A8D6);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Orbitron', monospace;
    font-weight: 900;
    color: #fff;
    font-size: 0.9rem;
    box-shadow: 0 0 15px rgba(225, 60, 250, 0.4);
  }
  
  .signal-user {
    font-weight: 600;
    color: #28A8D6;
    font-size: clamp(0.875rem, 1.2vw, 1rem);
  }
  
  .signal-timestamp {
    font-size: clamp(0.75rem, 1vw, 0.875rem);
    color: rgba(255, 255, 255, 0.6);
    margin-left: auto;
  }
  
  .signal-content {
    font-size: clamp(0.875rem, 1.2vw, 1rem);
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 1rem;
  }
  
  .signal-hashtags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .hashtag {
    color: #F4FF30;
    font-size: clamp(0.75rem, 1vw, 0.875rem);
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .hashtag:hover {
    color: #00F0AC;
    text-shadow: 0 0 10px currentColor;
  }
  
  .signal-refresh {
    text-align: center;
    margin-top: 3rem;
  }
  
  .refresh-btn {
    background: transparent;
    border: 2px solid #F4FF30;
    color: #F4FF30;
    padding: 1rem 2rem;
    font-family: 'Orbitron', monospace;
    font-size: clamp(0.875rem, 1.2vw, 1rem);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border-radius: 8px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .refresh-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: #F4FF30;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
    z-index: -1;
  }
  
  .refresh-btn:hover {
    color: #0A0A0A;
    box-shadow: 0 0 30px rgba(244, 255, 48, 0.5);
  }
  
  .refresh-btn:hover::before {
    transform: scaleX(1);
  }
  
  .refresh-icon {
    font-size: 1.5rem;
    display: inline-block;
    transition: transform 0.6s ease;
  }
  
  .refresh-btn:hover .refresh-icon {
    transform: rotate(180deg);
  }
  
  @media (max-width: 768px) {
    .lore-signals {
      padding: 6rem 1rem;
    }
    
    .signal-item {
      padding: 1.5rem;
    }
  }
</style>

<script>
  // Refresh signals (integrate with X API or semantic search)
  async function refreshSignals() {
    const feed = document.getElementById('signalFeed');
    const btn = document.querySelector('.refresh-btn');
    btn.disabled = true;
    btn.querySelector('.refresh-icon').style.animation = 'spin 1s linear infinite';
    
    try {
      // X API semantic search integration
      const response = await fetch('/apps/stellar-signals/refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query: '{{ section.settings.search_query | default: "@StellarReverb OR #StellarReverb" }}',
          count: {{ section.settings.signal_count | default: 10 }}
        })
      });
      
      const data = await response.json();
      
      if (data.signals && data.signals.length) {
        // Clear existing signals
        feed.innerHTML = '';
        
        // Add new signals
        data.signals.forEach((signal, index) => {
          const signalHTML = `
            <div class="signal-item" style="animation-delay: ${index * 0.2}s">
              <div class="signal-header">
                <div class="signal-avatar" style="background: linear-gradient(135deg, #E13CFA, #28A8D6);">
                  ${signal.username.slice(0, 2).toUpperCase()}
                </div>
                <span class="signal-user orbitron">${signal.username}</span>
                <span class="signal-timestamp">${signal.timestamp}</span>
              </div>
              <div class="signal-content">${signal.content}</div>
              <div class="signal-hashtags">
                ${signal.hashtags.map(tag => `<span class="hashtag">${tag}</span>`).join('')}
              </div>
            </div>
          `;
          feed.insertAdjacentHTML('beforeend', signalHTML);
        });
      }
    } catch (error) {
      console.error('Error refreshing signals:', error);
    } finally {
      btn.disabled = false;
      btn.querySelector('.refresh-icon').style.animation = '';
    }
  }
  
  // Auto-refresh every 30 seconds if enabled
  {% if section.settings.auto_refresh %}
    setInterval(refreshSignals, 30000);
  {% endif %}
</script>

<style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>

{% schema %}
{
  "name": "Signal Feed",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "LIVE SIGNAL FEED"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Real-time transmissions from the cosmic community"
    },
    {
      "type": "checkbox",
      "id": "enable_live_feed",
      "label": "Enable Live Feed Updates",
      "default": true,
      "info": "Requires X/Twitter API integration"
    },
    {
      "type": "checkbox",
      "id": "auto_refresh",
      "label": "Auto-refresh Every 30 Seconds",
      "default": false
    },
    {
      "type": "text",
      "id": "search_query",
      "label": "X/Twitter Search Query",
      "default": "@StellarReverb OR #StellarReverb",
      "info": "Used for semantic search"
    },
    {
      "type": "range",
      "id": "signal_count",
      "label": "Number of Signals",
      "min": 5,
      "max": 20,
      "step": 5,
      "default": 10
    }
  ],
  "blocks": [
    {
      "type": "signal",
      "name": "Signal",
      "settings": [
        {
          "type": "text",
          "id": "username",
          "label": "Username",
          "default": "@CosmicTraveler"
        },
        {
          "type": "text",
          "id": "content",
          "label": "Signal Content",
          "default": "The frequencies are aligning... something big is coming ğŸŒŒ"
        },
        {
          "type": "text",
          "id": "hashtags",
          "label": "Hashtags (comma-separated)",
          "default": "#StellarReverb, #CosmicTransmission"
        },
        {
          "type": "text",
          "id": "timestamp",
          "label": "Timestamp",
          "default": "2m ago"
        },
        {
          "type": "color",
          "id": "avatar_color_1",
          "label": "Avatar Gradient Start",
          "default": "#E13CFA"
        },
        {
          "type": "color",
          "id": "avatar_color_2",
          "label": "Avatar Gradient End",
          "default": "#28A8D6"
        },
        {
          "type": "select",
          "id": "signal_type",
          "label": "Signal Type",
          "options": [
            { "value": "community", "label": "Community" },
            { "value": "official", "label": "Official" },
            { "value": "featured", "label": "Featured" }
          ],
          "default": "community"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Lore Signal Feed",
      "blocks": [
        {
          "type": "signal",
          "settings": {
            "username": "@VoidSeeker",
            "content": "Just decoded the frequencies in the new drop... ğŸ‘ï¸",
            "hashtags": "#StellarReverb, #VoidSignals"
          }
        },
        {
          "type": "signal",
          "settings": {
            "username": "@QuantumEcho",
            "content": "The cassette tapes are speaking in frequencies only machines understand ğŸ”®",
            "hashtags": "#StellarReverb, #AnalogMysticism"
          }
        }
      ]
    }
  ]
}
{% endschema %}