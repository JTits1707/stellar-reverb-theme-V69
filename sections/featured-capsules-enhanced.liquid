{% comment %}
  STELLAR REVERB — FEATURED CAPSULE (Transmission Spotlight)
  - Metaobject-driven (Capsule)
  - Reliable tag image render (file_reference OR image)
  - 3 modes: pick / auto / manual
{% endcomment %}

<section
  class="sr-featured-capsule"
  data-section-id="{{ section.id }}"
>
  {{ 'featured-capsule.css' | asset_url | stylesheet_tag }}

  {%- liquid
    assign mode = section.settings.mode
    assign capsule_obj = nil

    if mode == 'pick' and section.settings.capsule_metaobject != blank
      assign capsule_obj = section.settings.capsule_metaobject
    elsif mode == 'auto'
      assign capsules = shop.metaobjects.capsule.values

      if capsules != blank
        assign featured_candidate = nil

        for c in capsules
          if c == blank
            continue
          endif

          comment
            Try common "featured" booleans if you have them:
            - featured
            - is_featured
            - spotlight
            - prime
          endcomment

          if c.featured == true or c.is_featured == true or c.spotlight == true or c.prime == true
            assign featured_candidate = c
            break
          endif
        endfor

        if featured_candidate != nil
          assign capsule_obj = featured_candidate
        else
          assign capsule_obj = capsules.first
        endif
      endif
    endif

    comment
      If capsule_obj exists, prefer metaobject fields.
      Otherwise, fall back to manual settings.
    endcomment

    assign capsule_number = ''
    assign capsule_title  = ''
    assign capsule_link   = ''
    assign capsule_lore   = ''
    assign tag_image      = nil

    if capsule_obj != nil
      comment
        Numbers/titles may be stored as:
        - capsule_number (text/number)
        - capsule_title
        - capsule_slug (for linking)
      endcomment

      if capsule_obj.capsule_number != blank
        assign capsule_number = capsule_obj.capsule_number.value | default: capsule_obj.capsule_number
      endif

      if capsule_obj.capsule_title != blank
        assign capsule_title = capsule_obj.capsule_title.value | default: capsule_obj.capsule_title
      endif

      if capsule_obj.capsule_short_lore != blank
        assign capsule_lore = capsule_obj.capsule_short_lore.value | default: capsule_obj.capsule_short_lore
      endif

      comment
        TAG IMAGE — the problem child.
        Handle both:
        - file_reference (needs .value sometimes)
        - image fields
      endcomment

      if capsule_obj.capsule_tag_image != blank
        assign tag_image = capsule_obj.capsule_tag_image.value | default: capsule_obj.capsule_tag_image
      endif

      comment
        Link logic:
        If you store a URL field like capsule_url, use it.
        Otherwise build from slug if available.
      endcomment

      if capsule_obj.capsule_url != blank
        assign capsule_link = capsule_obj.capsule_url.value | default: capsule_obj.capsule_url
      elsif capsule_obj.capsule_slug != blank
        assign slug = capsule_obj.capsule_slug.value | default: capsule_obj.capsule_slug
        assign capsule_link = routes.root_url | append: 'pages/' | append: slug
      endif
    endif

    if capsule_title == blank
      assign capsule_title = section.settings.manual_title
    endif
    if capsule_number == blank
      assign capsule_number = section.settings.manual_number
    endif
    if capsule_link == blank
      assign capsule_link = section.settings.manual_link
    endif
    if tag_image == nil and section.settings.manual_tag_image != blank
      assign tag_image = section.settings.manual_tag_image
    endif
  -%}

  <div class="sr-featured-capsule__wrap page-width">

    {%- if section.settings.kicker != blank -%}
      <div class="sr-featured-capsule__kicker">{{ section.settings.kicker }}</div>
    {%- endif -%}

    {%- if section.settings.heading != blank -%}
      <h2 class="sr-featured-capsule__heading">{{ section.settings.heading }}</h2>
    {%- endif -%}

    <div class="sr-featured-capsule__card">
      <div class="sr-featured-capsule__badge" role="note" aria-label="Featured capsule badge">
        <span class="sr-featured-capsule__badge-icon" aria-hidden="true">★</span>
        <span class="sr-featured-capsule__badge-text">
          {{ section.settings.badge_text | default: 'FEATURED TRANSMISSION' }}
        </span>
      </div>

      <div class="sr-featured-capsule__media">
        {%- if tag_image != nil -%}
          {%- assign w = section.settings.tag_image_width | default: 320 -%}
          <div class="sr-featured-capsule__tag">
            <img
              src="{{ tag_image | image_url: width: w }}"
              alt="{{ capsule_title | escape }}"
              loading="lazy"
              width="{{ w }}"
              height="{{ w }}"
            >
          </div>
        {%- else -%}
          <div class="sr-featured-capsule__tag sr-featured-capsule__tag--placeholder" aria-hidden="true">
            <span class="sr-featured-capsule__tag-placeholder-line"></span>
            <span class="sr-featured-capsule__tag-placeholder-line"></span>
          </div>
        {%- endif -%}
      </div>

      <div class="sr-featured-capsule__meta">
        {%- if capsule_number != blank -%}
          <div class="sr-featured-capsule__capsule-number">
            {{ capsule_number }}
          </div>
        {%- endif -%}

        <div class="sr-featured-capsule__title">
          {{ capsule_title | default: 'UNTITLED' }}
        </div>

        {%- if capsule_lore != blank and section.settings.show_lore == true -%}
          <div class="sr-featured-capsule__lore">
            {{ capsule_lore }}
          </div>
        {%- endif -%}

        {%- if capsule_link != blank -%}
          <a class="sr-featured-capsule__cta" href="{{ capsule_link }}">
            {{ section.settings.cta_text | default: 'READ_LORE' }}
          </a>
        {%- endif -%}
      </div>
    </div>

  </div>

 {%- assign badge_bg = section.settings.badge_bg | default: '#F4FF30' -%}
{%- assign badge_text = section.settings.badge_text_color | default: '#0D0D0D' -%}
{%- assign border_base = section.settings.card_border | default: '#28A8D6' -%}

<style>
  .sr-featured-capsule__badge{
    background: {{ badge_bg }};
    color: {{ badge_text }};
  }
  .sr-featured-capsule__card{
    border-color: {{ border_base | color_modify: 'alpha', 0.25 }};
  }
</style>

</section>

{% schema %}
{
  "name": "Featured Capsule",
  "settings": [
    {
      "type": "select",
      "id": "mode",
      "label": "Capsule source",
      "default": "pick",
      "options": [
        { "value": "pick", "label": "Pick capsule (metaobject)" },
        { "value": "auto", "label": "Auto (find featured / fallback first)" },
        { "value": "manual", "label": "Manual fallback" }
      ]
    },
    {
      "type": "metaobject",
      "id": "capsule_metaobject",
      "label": "Select capsule metaobject",
      "metaobject_type": "capsule"
    },
    {
      "type": "text",
      "id": "kicker",
      "label": "Small kicker text",
      "default": "FEATURED TRANSMISSION"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "FEATURED\nTRANSMISSION"
    },
    {
      "type": "text",
      "id": "badge_text",
      "label": "Badge text",
      "default": "FEATURED TRANSMISSION"
    },
    {
      "type": "color",
      "id": "badge_bg",
      "label": "Badge background",
      "default": "#F4FF30"
    },
    {
      "type": "color",
      "id": "badge_text_color",
      "label": "Badge text color",
      "default": "#0D0D0D"
    },
    {
      "type": "color",
      "id": "card_border",
      "label": "Card border color",
     "default": "#28A8D6"
   },
    {
      "type": "range",
      "id": "tag_image_width",
      "label": "Tag image width (px)",
      "min": 160,
      "max": 520,
      "step": 20,
      "default": 320
    },
    {
      "type": "checkbox",
      "id": "show_lore",
      "label": "Show short lore",
      "default": false
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "CTA text",
      "default": "READ_LORE"
    },

    {
      "type": "header",
      "content": "Manual fallback fields"
    },
    {
      "type": "text",
      "id": "manual_number",
      "label": "Manual capsule number",
      "default": "CAPSULE 001"
    },
    {
      "type": "text",
      "id": "manual_title",
      "label": "Manual capsule title",
      "default": "UNTITLED"
    },
    {
      "type": "url",
      "id": "manual_link",
      "label": "Manual capsule link"
    },
    {
      "type": "image_picker",
      "id": "manual_tag_image",
      "label": "Manual tag image"
    }
  ],
  "presets": [
    {
      "name": "Featured Capsule"
    }
  ]
}
{% endschema %}