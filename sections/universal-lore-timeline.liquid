{% comment %}
UNIVERSAL LORE – MULTI-TRACK TIMELINE
Tracks: prime, lunar, singularity, hidden
Powered by capsule metaobjects
{% endcomment %}

<section id="timeline" class="universal-lore-timeline" data-section-type="lore-timeline">
  {% assign all_capsules = metaobjects.capsule.values %}

  {% assign prime_capsules       = all_capsules | where: 'timeline_track', 'prime'       | sort: 'timeline_order' %}
  {% assign lunar_capsules       = all_capsules | where: 'timeline_track', 'lunar'       | sort: 'timeline_order' %}
  {% assign singularity_capsules = all_capsules | where: 'timeline_track', 'singularity' | sort: 'timeline_order' %}
  {% assign hidden_capsules      = all_capsules | where: 'timeline_track', 'hidden'      | sort: 'timeline_order' %}

  <div id="timelineDesktop" class="timeline-desktop">
    <div class="timeline-track track-prime">
      <h3 class="track-label orbitron">Prime Timeline</h3>
      <div class="track-line">
        {% for capsule in prime_capsules %}
          {% assign number = capsule.capsule_number %}
          {% assign state  = capsule.signal_state | default: 'live' %}
          {% assign collection_handle = capsule.collection_handle %}
          {% assign product_url = collection_handle | prepend: '/collections/' %}

          <button
            class="timeline-node {% if state == 'incoming' %}incoming{% endif %}"
            data-capsule="{{ number }}"
            data-product-url="{{ product_url }}"
            data-audio="{{ capsule.audio_preview | default: '' }}"
            type="button"
          >
            <div class="node-geometry"></div>
            <div class="node-content">
              <span class="node-number">{{ number }}</span>
              <span class="orbitron node-title">{{ capsule.capsule_title }}</span>
              <span class="node-teaser">{{ capsule.capsule_lore_short | strip_html | truncate: 90 }}</span>
            </div>
          </button>
        {% endfor %}
      </div>
    </div>

    <div class="timeline-track track-lunar">
      <h3 class="track-label orbitron">Lunar Archives</h3>
      <div class="track-line">
        {% for capsule in lunar_capsules %}
          {% assign number = capsule.capsule_number %}
          {% assign state  = capsule.signal_state | default: 'live' %}
          {% assign collection_handle = capsule.collection_handle %}
          {% assign product_url = collection_handle | prepend: '/collections/' %}

          <button
            class="timeline-node {% if state == 'incoming' %}incoming{% endif %}"
            data-capsule="{{ number }}"
            data-product-url="{{ product_url }}"
            data-audio="{{ capsule.audio_preview | default: '' }}"
            type="button"
          >
            <div class="node-geometry"></div>
            <div class="node-content">
              <span class="node-number">{{ number }}</span>
              <span class="orbitron node-title">{{ capsule.capsule_title }}</span>
              <span class="node-teaser">{{ capsule.capsule_lore_short | strip_html | truncate: 90 }}</span>
            </div>
          </button>
        {% endfor %}
      </div>
    </div>

    <div class="timeline-track track-singularity">
      <h3 class="track-label orbitron">Singularity Lineage</h3>
      <div class="track-line">
        {% for capsule in singularity_capsules %}
          {% assign number = capsule.capsule_number %}
          {% assign state  = capsule.signal_state | default: 'live' %}
          {% assign collection_handle = capsule.collection_handle %}
          {% assign product_url = collection_handle | prepend: '/collections/' %}

          <button
            class="timeline-node {% if state == 'incoming' %}incoming{% endif %}"
            data-capsule="{{ number }}"
            data-product-url="{{ product_url }}"
            data-audio="{{ capsule.audio_preview | default: '' }}"
            type="button"
          >
            <div class="node-geometry"></div>
            <div class="node-content">
              <span class="node-number">{{ number }}</span>
              <span class="orbitron node-title">{{ capsule.capsule_title }}</span>
              <span class="node-teaser">{{ capsule.capsule_lore_short | strip_html | truncate: 90 }}</span>
            </div>
          </button>
        {% endfor %}
      </div>
    </div>

    <div class="timeline-track track-hidden">
      <h3 class="track-label orbitron">Hidden Signals</h3>
      <div class="track-line">
        {% for capsule in hidden_capsules %}
          {% assign number = capsule.capsule_number %}
          {% assign state  = capsule.signal_state | default: 'incoming' %}
          {% assign collection_handle = capsule.collection_handle %}
          {% assign product_url = collection_handle | prepend: '/collections/' %}

          <button
            class="timeline-node incoming"
            data-capsule="{{ number | default: 'incoming' }}"
            data-product-url="{% if state == 'live' %}{{ product_url }}{% else %}#{% endif %}"
            data-audio="{{ capsule.audio_preview | default: '' }}"
            type="button"
          >
            <div class="node-geometry"></div>
            <div class="node-content">
              <span class="node-number">
                {% if number %}{{ number }}{% else %}⋯{% endif %}
              </span>
              <span class="orbitron node-title">
                {{ capsule.capsule_title | default: 'Incoming Transmission' }}
              </span>
              <span class="node-teaser">
                {{ capsule.capsule_lore_short | default: 'Signal not yet decoded. Join the list to be first in.' | strip_html | truncate: 90 }}
              </span>
            </div>
          </button>
        {% endfor %}
      </div>
    </div>
  </div>

  {%- comment -%}
    Mobile timeline → your existing accordion structure.
    Just reuse the same capsule groups above but render as .accordion-item.
  {%- endcomment -%}
  <div id="timelineMobile" class="timeline-mobile">
    {% for capsule in prime_capsules %}
      {% assign number = capsule.capsule_number %}
      {% assign state  = capsule.signal_state | default: 'live' %}
      {% assign collection_handle = capsule.collection_handle %}
      {% assign product_url = collection_handle | prepend: '/collections/' %}

      <div class="accordion-item">
        <button
          class="accordion-header"
          data-target="capsule-{{ number }}-content"
          aria-expanded="false"
        >
          <span class="orbitron">{{ number }} · {{ capsule.capsule_title }}</span>
          <span class="icon-expand">+</span>
        </button>
        <div
          id="capsule-{{ number }}-content"
          class="accordion-content"
        >
          <p>{{ capsule.capsule_lore_short }}</p>
          <a
            href="{{ product_url }}"
            class="cta-link"
          >
            Enter this transmission
          </a>
        </div>
      </div>
    {% endfor %}
    {# You can duplicate similar blocks for lunar/singularity/hidden if you want full parity on mobile #}
  </div>
</section>