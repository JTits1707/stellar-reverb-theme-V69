{%- comment -%}
STELLAR REVERB - UNIVERSAL LORE TIMELINE SECTION
Switched timeline to capsule metaobjects:
- shop.metaobjects['capsule'].values
- data-capsule attribute
- Preserved all JS hooks: .timeline-node, #timelineDesktop, #timelineMobile, etc.
{%- endcomment -%}

{%- liquid
  # Get all capsules from metaobjects, sorted by capsule_number
  assign capsules = shop.metaobjects['capsule'].values | sort: 'capsule_number'
  
  # Section settings
  assign section_title = section.settings.section_title
  assign max_items = section.settings.max_items | default: 8
  assign show_product_links = section.settings.show_product_links
  assign future_signal_title = section.settings.future_signal_title
  assign future_signal_text = section.settings.future_signal_text
-%}

<section class="timeline-section section-{{ section.id }}" 
         data-section-id="{{ section.id }}" 
         data-section-type="lore-timeline"
         id="timeline">
    
    <div class="container">
        <h2 class="section-title orbitron">
            {{ section_title | default: 'TRANSMISSION ARCHIVE' }}
        </h2>
        
        <!-- Desktop Timeline - Required ID for universal-lore.js -->
        <div class="timeline-desktop hide-mobile" id="timelineDesktop">
            <div class="timeline-line" aria-hidden="true"></div>
            
            {% for capsule in capsules limit: max_items %}
                {%- liquid
                  # Generate teaser from capsule lore
                  assign teaser_text = capsule.capsule_lore | strip_html | truncate: 140
                  
                  # Optional: Find associated product by capsule_number metafield
                  assign associated_product = null
                  assign product_url = null
                  assign audio_file = null
                  
                  if show_product_links
                    for product in collections.all.products
                      if product.metafields.custom.capsule_number == capsule.capsule_number
                        assign associated_product = product
                        assign product_url = product.url
                        assign audio_file = product.metafields.custom.audio_preview
                        break
                      endif
                    endfor
                  endif
                -%}
                
                <div class="timeline-node" 
                     data-capsule="{{ capsule.capsule_number }}"
                     {% if audio_file %}data-audio="{{ audio_file }}"{% endif %}
                     {% if product_url %}data-product-url="{{ product_url }}"{% endif %}
                     tabindex="0"
                     role="button"
                     aria-label="Capsule {{ capsule.capsule_number }}: {{ capsule.capsule_title }}">
                    
                    <div class="node-marker{% if forloop.last %} active{% endif %}"></div>
                    
                    <div class="node-content">
                        <h3 class="orbitron">
                            {{ capsule.capsule_number }}: {{ capsule.capsule_title | upcase }}
                        </h3>
                        
                        <p class="node-teaser">{{ teaser_text }}</p>
                        
                        {% if associated_product %}
                            <time class="node-date">
                                {{ associated_product.created_at | date: '%Y.%m.%d' }}
                            </time>
                            
                            {% if associated_product.price > 0 %}
                            <div class="node-price">
                                {{ associated_product.price | money }}
                                {% if associated_product.compare_at_price > associated_product.price %}
                                    <span class="compare-price">{{ associated_product.compare_at_price | money }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endif %}
                        
                        <!-- Required geometry element for animations -->
                        <div class="node-geometry" aria-hidden="true">
                            <!-- SVG waveform path for animations -->
                            <svg class="waveform-display" viewBox="0 0 100 20" xmlns="http://www.w3.org/2000/svg">
                                <path class="waveform-path" 
                                      d="M0,10 Q25,{{ forloop.index | modulo: 3 | times: 5 | plus: 5 }} 50,10 T100,10" 
                                      stroke="var(--cyan-blue)" 
                                      stroke-width="1" 
                                      fill="none">
                                </path>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="audio-preview" aria-label="Audio preview for {{ capsule.capsule_title }}"></div>
                </div>
            {% endfor %}
            
            <!-- Incoming Signal Node -->
            {% if future_signal_title != blank %}
            <div class="timeline-node future-signal" data-capsule="incoming">
                <div class="node-marker pulse-active"></div>
                <div class="node-content">
                    <h3 class="orbitron">{{ future_signal_title | default: '999: INCOMING SIGNAL DETECTED' }}</h3>
                    <p class="node-teaser">{{ future_signal_text | default: 'New transmission incoming... decryption in progress...' }}</p>
                    <time class="node-date">{{ 'now' | date: '%Y.%m.%d' }}</time>
                    <div class="node-geometry active" aria-hidden="true"></div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Mobile Timeline (Accordion) - Required ID for universal-lore.js -->
        <div class="timeline-mobile show-mobile" id="timelineMobile">
            {% for capsule in capsules limit: max_items %}
                {%- liquid
                  # Find associated product for mobile view
                  assign associated_product = null
                  if show_product_links
                    for product in collections.all.products
                      if product.metafields.custom.capsule_number == capsule.capsule_number
                        assign associated_product = product
                        break
                      endif
                    endfor
                  endif
                -%}
                
                <div class="accordion-item">
                    <!-- Required accordion-header class for universal-lore.js -->
                    <button class="accordion-header" 
                            data-target="capsule-{{ forloop.index }}"
                            aria-expanded="false"
                            aria-controls="capsule-{{ forloop.index }}">
                        <span class="orbitron">{{ capsule.capsule_number }}: {{ capsule.capsule_title | upcase }}</span>
                        <i class="icon-expand" aria-hidden="true">+</i>
                    </button>
                    
                    <div class="accordion-content" id="capsule-{{ forloop.index }}">
                        <div class="capsule-lore">
                            {{ capsule.capsule_lore | strip_html | truncate: 200 }}
                        </div>
                        
                        {% if associated_product %}
                            <time class="capsule-date">{{ associated_product.created_at | date: '%Y.%m.%d' }}</time>
                            
                            <div class="capsule-actions">
                                <a href="{{ associated_product.url }}" class="btn-capsule">
                                    VIEW CAPSULE
                                </a>
                                {% if associated_product.available and associated_product.price > 0 %}
                                    <button class="btn-add-to-cart" 
                                            data-product-id="{{ associated_product.id }}"
                                            data-variant-id="{{ associated_product.selected_or_first_available_variant.id }}">
                                        ADD TO CART - {{ associated_product.price | money }}
                                    </button>
                                {% endif %}
                            </div>
                        {% else %}
                            <!-- No associated product, just show explore link -->
                            <div class="capsule-actions">
                                <a href="/collections/capsule-{{ capsule.capsule_number }}" class="btn-capsule">
                                    EXPLORE CAPSULE {{ capsule.capsule_number }}
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</section>

{% schema %}
{
  "name": "Universal Lore Timeline",
  "settings": [
    {
      "type": "header",
      "content": "Timeline Settings"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "TRANSMISSION ARCHIVE"
    },
    {
      "type": "range",
      "id": "max_items",
      "min": 3,
      "max": 15,
      "step": 1,
      "label": "Maximum Capsules to Display",
      "default": 8,
      "info": "Number of capsules to show from the metaobject collection"
    },
    {
      "type": "checkbox",
      "id": "show_product_links",
      "label": "Show Product Links",
      "default": true,
      "info": "Find and link products with matching capsule_number metafield"
    },
    {
      "type": "header",
      "content": "Future Signal Settings"
    },
    {
      "type": "text",
      "id": "future_signal_title",
      "label": "Future Signal Title",
      "default": "999: INCOMING SIGNAL DETECTED"
    },
    {
      "type": "textarea",
      "id": "future_signal_text",
      "label": "Future Signal Description",
      "default": "New transmission incoming... decryption in progress..."
    }
  ],
  "presets": [
    {
      "name": "Universal Lore Timeline",
      "category": "Stellar Reverb"
    }
  ]
}
{% endschema %}