{% comment %}
Section: Transmission Hero
- Glitch void hero, floating cassettes, myth toggle, teaser copy
- Pulls featured “capsule” from first product of collections['transmissions'] (overrideable via setting)
- AR portal entry (model-viewer) conditionally loads
- Klaviyo “rift-signup” embed available via setting (form ID)
ASSETS (in /assets):
- glitch-particles.webp, waveforms.svg, triangles.svg
- cassette1.webp, cassette2.webp, cassette3.webp
{% endcomment %}

<section class="hero" aria-label="Transmission Archive">
  <div class="glitch-bg" aria-hidden="true"></div>

  {%- comment -%} Glitch particles overlay {%- endcomment -%}
  <img class="particles" src="{{ 'glitch-particles.webp' | asset_url }}" alt="" width="1600" height="900" loading="eager" fetchpriority="high">

  {%- comment -%} Floating cassette motifs (lazy swapped) {%- endcomment -%}
  <div class="cassettes" aria-hidden="true">
    <img class="cass float-a" style="top:8%;left:10%" data-src="{{ 'cassette1.webp' | asset_url }}" alt="">
    <img class="cass float-b" style="bottom:12%;right:12%" data-src="{{ 'cassette2.webp' | asset_url }}" alt="">
    <img class="cass float-a" style="top:22%;right:28%" data-src="{{ 'cassette3.webp' | asset_url }}" alt="">
  </div>

  <div class="wrap grid" style="gap:18px;text-align:center">
    <h1 class="title-cap" style="font-weight:900;font-size:clamp(28px,6vw,64px);color:var(--magenta)">
      Transmission Archive
    </h1>
    <p style="max-width:46ch;margin-inline:auto;color:var(--mute)">
      Capsules drifting through neon voids. Tune the myth, crack the cassette, step through the rift.
    </p>

    {%- comment -%} Myth toggle (from global setting or metafield presence) {%- endcomment -%}
    {% if section.settings.show_myth_toggle %}
      <div>
        <button class="btn" data-myth-toggle>
          Toggle Myth Layer
        </button>
      </div>
    {% endif %}

    {%- assign source_collection = collections[section.settings.collection_handle] | default: collections['transmissions'] -%}
    {%- assign featured = source_collection.products | first -%}
    {% if featured %}
      <div class="grid" style="gap:10px;justify-items:center">
        <div class="badge">Featured Capsule</div>
        <a class="btn" href="{{ featured.url }}">Open {{ featured.title }}</a>

        {%- assign teaser = featured.metafields.custom.teaser -%}
        {% if teaser != blank %}
          <p style="max-width:60ch;color:var(--ink);opacity:.9">{{ teaser }}</p>
        {% endif %}

        {%- comment -%} AR Portal via model-viewer (progressive injection) {%- endcomment -%}
        {%- assign glb = featured.metafields.custom.glb_url -%}
        {%- assign usdz = featured.metafields.custom.usdz_url -%}
        {% if glb != blank %}
          <div id="ar-portal-hero" style="width:min(90vw,560px);aspect-ratio:1/1;border:1px solid #2a0034;border-radius:16px;overflow:hidden">
            <div id="mv-holder-hero" data-glb="{{ glb }}" data-usdz="{{ usdz | default: '' }}"></div>
          </div>
        {% endif %}
      </div>
    {% endif %}

    {%- if section.settings.klaviyo_form_id != blank -%}
      <div class="grid" style="gap:10px;margin-top:10px">
        <div class="badge">Rift Signup</div>
        <div class="klaviyo-form-embed" data-klaviyo-form-id="{{ section.settings.klaviyo_form_id }}"></div>
        {%- comment -%} Ensure Klaviyo onsite script is globally present or inject here if needed {%- endcomment -%}
      </div>
    {%- endif -%}
  </div>
</section>

<script>
  // Lazy swap floating cassette data-src → src
  (function(){
    const imgs = document.querySelectorAll('.cassettes img[data-src]');
    const io = new IntersectionObserver((ents)=>{
      ents.forEach(e=>{
        if(e.isIntersecting){
          const el=e.target; el.src=el.dataset.src; el.removeAttribute('data-src'); io.unobserve(el);
        }
      })
    },{rootMargin:'200px'});
    imgs.forEach(i=>io.observe(i));
  })();

  // Myth toggle: add/remove data-myth on <html>
  (function(){
    const btn = document.querySelector('[data-myth-toggle]');
    if(btn){
      btn.addEventListener('click',()=>{
        const root = document.documentElement;
        const on = root.getAttribute('data-myth') === 'on';
        root.setAttribute('data-myth', on ? 'off' : 'on');
      })
    }
  })();

  // Load model-viewer only when hero AR holder is visible
  (function(){
    const holder = document.getElementById('mv-holder-hero');
    if(!holder) return;
    const loadMV = ()=>{
      if(customElements.get('model-viewer')) return Promise.resolve();
      return new Promise(res=>{
        const s = document.createElement('script');
        s.type='module';
        s.src='https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js';
        s.onload=res;
        document.head.appendChild(s);
      });
    };
    const mount = async ()=>{
      await loadMV();
      if(!holder) return;
      const glb = holder.dataset.glb;
      const usdz = holder.dataset.usdz || '';
      holder.innerHTML =
        `<model-viewer src="${glb}" ios-src="${usdz}" ar ar-modes="webxr scene-viewer quick-look"
          camera-controls touch-action="pan-y" style="width:100%;height:100%;background:#08000e"
          environment-image="neutral" exposure="1.1" shadow-intensity="1"></model-viewer>`;
    };
    const io = new IntersectionObserver((ents)=>{
      ents.forEach(e=>{ if(e.isIntersecting){ mount(); io.disconnect(); } });
    },{rootMargin:'200px'});
    io.observe(holder);
  })();
</script>

{% schema %}
{
  "name": "Transmission Hero",
  "settings": [
    { "type": "text", "id": "collection_handle", "label": "Transmissions collection handle", "default": "transmissions" },
    { "type": "checkbox", "id": "show_myth_toggle", "label": "Enable Myth Toggle", "default": true },
    { "type": "text", "id": "klaviyo_form_id", "label": "Klaviyo Form ID (optional)" }
  ],
  "presets": [{ "name": "Transmission Hero" }]
}
{% endschema %}