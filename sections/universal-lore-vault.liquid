{% comment %}
UNIVERSAL LORE – RELIC VAULT
Grid of capsules as "glyph" relics.

Powered by capsule metaobjects:
- Uses signal_state to prefer live capsules.
- Falls back to all capsules if none are live.
- Hooks into universal-lore.js via .glyph-item and data attributes.
{% endcomment %}

<section class="universal-lore-vault" data-section-type="lore-vault">
  {%- assign all_capsules = metaobjects.capsule.values -%}
  {%- assign live_capsules = all_capsules | where: 'signal_state', 'live' -%}
  {%- if live_capsules.size > 0 -%}
    {%- assign capsules = live_capsules -%}
  {%- else -%}
    {%- assign capsules = all_capsules -%}
  {%- endif -%}

  {%- assign capsules = capsules | sort: 'timeline_order' -%}

  {%- if section.settings.max_items > 0 -%}
    {%- assign capsules = capsules | slice: 0, section.settings.max_items -%}
  {%- endif -%}

  <div class="vault-inner container">
    <header class="vault-header">
      <p class="vault-kicker orbitron">
        {{ section.settings.kicker | default: 'RELIC VAULT · ACTIVE SIGNALS' }}
      </p>
      <h2 class="vault-title orbitron">
        {{ section.settings.heading | default: 'Choose Your Transmission' }}
      </h2>
      <p class="vault-subtitle">
        {{ section.settings.subheading | default: "Each capsule is a self-contained myth, broadcast across time. Pick a node and step into its frequency." }}
      </p>
    </header>

    <div class="vault-grid">
      {%- for capsule in capsules -%}
        {%- assign collection_handle = capsule.capsule_collection_handle | default: capsule.collection_handle -%}
        {%- assign product_url = '' -%}
        {%- if collection_handle != blank -%}
          {%- assign product_url = collection_handle | prepend: '/collections/' -%}
        {%- endif -%}

        {%- assign image = capsule.hero_image_main | default: capsule.capsule_hero | default: capsule.capsule_image_url -%}

        <article
          class="vault-item glyph-item"
          data-capsule-id="{{ capsule.id }}"
          data-track="{{ capsule.timeline_track }}"
          data-state="{{ capsule.signal_state }}"
        >
          <a href="{{ product_url }}" class="glyph-link" aria-label="Explore {{ capsule.capsule_title }}">
            <div class="glyph-inner">
              <div class="glyph-image">
                {%- if image != blank -%}
                  <img
                    src="{{ image | image_url: width: 400 }}"
                    srcset="
                      {{ image | image_url: width: 200 }} 200w,
                      {{ image | image_url: width: 400 }} 400w,
                      {{ image | image_url: width: 600 }} 600w
                    "
                    sizes="(min-width: 1024px) 25vw, (min-width: 768px) 33vw, 50vw"
                    alt="{{ capsule.capsule_title | escape }}"
                    loading="lazy"
                  >
                  <div class="glyph-overlay"></div>
                {%- else -%}
                  <div class="glyph-placeholder">
                    <span class="orbitron">{{ capsule.capsule_number }}</span>
                  </div>
                {%- endif -%}
              </div>

              <div class="glyph-info">
                {%- if capsule.capsule_number != blank -%}
                  <p class="glyph-number orbitron">{{ capsule.capsule_number }}</p>
                {%- endif -%}

                <h3 class="glyph-title">{{ capsule.capsule_title }}</h3>

                {%- if capsule.capsule_lore_short != blank -%}
                  <p class="glyph-lore">{{ capsule.capsule_lore_short | strip_html | truncate: 90 }}</p>
                {%- endif -%}

                {%- if capsule.timeline_track != blank -%}
                  <span class="glyph-track">
                    {%- case capsule.timeline_track -%}
                      {%- when 'prime' -%}Prime
                      {%- when 'lunar' -%}Lunar
                      {%- when 'singularity' -%}Singularity
                      {%- when 'hidden' -%}Hidden
                      {%- else -%}{{ capsule.timeline_track | capitalize }}
                    {%- endcase -%}
                  </span>
                {%- endif -%}

                {%- if capsule.signal_state == 'live' -%}
                  <span class="glyph-badge live">LIVE</span>
                {%- elsif capsule.signal_state == 'archived' -%}
                  <span class="glyph-badge archived">ARCHIVED</span>
                {%- endif -%}
              </div>
            </div>
          </a>
        </article>
      {%- else -%}
        <div class="vault-empty">
          <p class="orbitron">No transmissions detected.</p>
          <p>The vault is silent. Check back when the signals return.</p>
        </div>
      {%- endfor -%}
    </div>

    {%- if section.settings.show_cta and section.settings.cta_url != blank -%}
      <footer class="vault-footer">
        <a href="{{ section.settings.cta_url }}" class="cta-primary btn">
          {{ section.settings.cta_label | default: 'Explore All Capsules' }}
        </a>
      </footer>
    {%- endif -%}
  </div>
</section>

<style>
.universal-lore-vault {
  padding: 80px 0;
  background: var(--color-bg-primary, #000);
  color: var(--color-text-primary, #fff);
}

.vault-header {
  text-align: center;
  margin-bottom: 60px;
}

.vault-kicker {
  font-size: 0.75rem;
  letter-spacing: 0.2em;
  color: var(--color-accent, #E13CFA);
  margin-bottom: 12px;
}

.vault-title {
  font-size: clamp(2rem, 5vw, 3.5rem);
  margin-bottom: 16px;
  background: linear-gradient(135deg, #E13CFA, #28A8D6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.vault-subtitle {
  font-size: 1.125rem;
  opacity: 0.8;
  max-width: 600px;
  margin: 0 auto;
}

.vault-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 24px;
}

.vault-item {
  position: relative;
  overflow: hidden;
  border-radius: 8px;
  transition: transform 0.3s ease;
}

.vault-item:hover {
  transform: translateY(-4px);
}

.glyph-link {
  display: block;
  text-decoration: none;
  color: inherit;
}

.glyph-image {
  position: relative;
  aspect-ratio: 1;
  overflow: hidden;
  background: linear-gradient(135deg, rgba(225,60,250,0.1), rgba(40,168,214,0.1));
}

.glyph-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.vault-item:hover .glyph-image img {
  transform: scale(1.05);
}

.glyph-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, transparent, rgba(0,0,0,0.7));
}

.glyph-info {
  padding: 16px;
}

.glyph-number {
  font-size: 0.75rem;
  color: var(--color-accent, #E13CFA);
  margin-bottom: 8px;
}

.glyph-title {
  font-size: 1.25rem;
  margin-bottom: 8px;
}

.glyph-lore {
  font-size: 0.875rem;
  opacity: 0.7;
  margin-bottom: 12px;
}

.glyph-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 0.75rem;
  letter-spacing: 0.1em;
}

.glyph-badge.live {
  background: rgba(0,255,0,0.2);
  color: #0f0;
}

.vault-footer {
  text-align: center;
  margin-top: 48px;
}
</style>

{% schema %}
{
  "name": "Universal Lore Vault",
  "tag": "section",
  "class": "section-universal-lore-vault",
  "settings": [
    {
      "type": "text",
      "id": "kicker",
      "label": "Kicker text",
      "default": "RELIC VAULT · ACTIVE SIGNALS"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section heading",
      "default": "Choose Your Transmission"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Section subheading",
      "default": "Each capsule is a self-contained myth, broadcast across time. Pick a node and step into its frequency."
    },
    {
      "type": "range",
      "id": "max_items",
      "label": "Max capsules to show",
      "min": 0,
      "max": 24,
      "step": 4,
      "default": 12,
      "info": "0 = show all"
    },
    {
      "type": "checkbox",
      "id": "show_cta",
      "label": "Show footer CTA",
      "default": false
    },
    {
      "type": "url",
      "id": "cta_url",
      "label": "CTA link URL"
    },
    {
      "type": "text",
      "id": "cta_label",
      "label": "CTA button label",
      "default": "Explore All Capsules"
    }
  ],
  "blocks": [],
  "presets": [
    {
      "name": "Universal Lore Vault",
      "category": "Stellar Reverb"
    }
  ]
}
{% endschema %}
