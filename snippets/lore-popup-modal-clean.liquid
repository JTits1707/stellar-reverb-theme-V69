{% comment %}
  ═══════════════════════════════════════════════════════════
  STELLAR REVERB - LORE POPUP MODAL (SNIPPET) — FINAL CLEAN
  ═══════════════════════════════════════════════════════════
{% endcomment %}

<div id="lore-modal" class="lore-modal" role="dialog" aria-modal="true" aria-labelledby="lore-modal-title">
  <div class="lore-modal-backdrop" id="lore-modal-backdrop"></div>

  <div class="lore-modal-container">
    <button class="lore-modal-close" id="lore-modal-close" aria-label="Close modal">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>

    <div class="lore-modal-header">
      <div class="lore-modal-tag orbitron" id="lore-modal-tag">TRANSMISSION</div>
      <h2 class="lore-modal-title orbitron" id="lore-modal-title">Loading...</h2>
    </div>

    <div class="lore-modal-body">
      <div class="lore-modal-content" id="lore-modal-content">
        <!-- Content injected via JS -->
      </div>
    </div>

    <div class="lore-modal-footer">
      <button class="lore-modal-cta" id="lore-modal-explore">
        EXPLORE THIS CAPSULE
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 10h10M10 5l5 5-5 5"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<style>
  /* ← All your beautiful CSS from before goes here → */
  /* (Exactly the same as you had — just without the merge conflict) */
  /* Paste your full CSS block here (the one with .lore-modal, backdrop blur, neon glow, etc.) */
</style>

<script>
  // ════════════════════════════════════════
  // FINAL LORE MODAL JS — CLEAN & PERFECT
  // ════════════════════════════════════════
  (function() {
    const modal = document.getElementById('lore-modal');
    const backdrop = document.getElementById('lore-modal-backdrop');
    const closeBtn = document.getElementById('lore-modal-close');
    const modalTag = document.getElementById('lore-modal-tag');
    const modalTitle = document.getElementById('lore-modal-title');
    const modalContent = document.getElementById('lore-modal-content');
    const exploreBtn = document.getElementById('lore-modal-explore');

    if (!modal) return;

    let currentCapsuleUrl = '';

    function openModal(data) {
      const { capsule, content } = data;
      modalTag.textContent = `CAPSULE ${capsule}`;
      modalContent.innerHTML = content;

      const temp = document.createElement('div');
      temp.innerHTML = content;
      const h3 = temp.querySelector('h3');
      modalTitle.textContent = h3 ? h3.textContent : `Capsule ${capsule}`;

      currentCapsuleUrl = `/pages/capsule-${capsule}`;

      modal.classList.add('is-active');
      document.body.classList.add('lore-modal-open');
      closeBtn.focus();
    }

    function closeModal() {
      modal.classList.remove('is-active');
      document.body.classList.remove('lore-modal-open');
      currentCapsuleUrl = '';
    }

    document.addEventListener('openLoreModal', e => openModal(e.detail));

    closeBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && modal.classList.contains('is-active')) closeModal();
    });

    exploreBtn.addEventListener('click', () => {
      if (currentCapsuleUrl) window.location.href = currentCapsuleUrl;
    });

    modal.querySelector('.lore-modal-container')?.addEventListener('click', e => e.stopPropagation());
  })();
</script>